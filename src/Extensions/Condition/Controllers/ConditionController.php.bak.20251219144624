<?php

declare(strict_types=1);

namespace AtoM\Framework\Extensions\Condition\Controllers;

use AtoM\Framework\Extensions\Condition\Services\ConditionEventService;
use AtoM\Framework\Extensions\Condition\Services\ConditionExportService;
use AtoM\Framework\Extensions\Condition\Services\ConditionRiskService;
use AtoM\Framework\Extensions\Condition\Services\ConditionVocabularyService;
use Illuminate\Database\Capsule\Manager as DB;
use Psr\Http\Message\ResponseInterface as Response;
use Psr\Http\Message\ServerRequestInterface as Request;

/**
 * Condition Controller
 *
 * Handles condition reporting, risk assessment, and conservation tracking.
 * Spectrum 5.0 compliant for museum cataloging standards.
 * Mimics AtoM 2.10 module layout and functionality.
 *
 * @author Johan Pieterse <johan@theahg.co.za>
 */
class ConditionController
{
    private $view;

    public function __construct($view)
    {
        $this->view = $view;
    }

    /**
     * Condition Dashboard
     * Route: GET /admin/condition
     */
    public function index(Request $request, Response $response): Response
    {
        $dashboard = ConditionRiskService::getDashboardSummary();
        $priorities = ConditionRiskService::getPrioritizedList(10);
        $recentEvents = ConditionEventService::getRecentEvents(10);

        // Get upcoming assessments
        $upcomingAssessments = DB::table('condition_assessment_schedule as cas')
            ->join('information_object as io', 'cas.object_id', '=', 'io.id')
            ->leftJoin('information_object_i18n as ioi', function ($join) {
                $join->on('io.id', '=', 'ioi.id')
                    ->where('ioi.culture', '=', 'en');
            })
            ->leftJoin('slug', 'io.id', '=', 'slug.object_id')
            ->where('cas.next_assessment_date', '>=', date('Y-m-d'))
            ->where('cas.next_assessment_date', '<=', date('Y-m-d', strtotime('+30 days')))
            ->select([
                'cas.*',
                'ioi.title',
                'io.identifier',
                'slug.slug',
            ])
            ->orderBy('cas.next_assessment_date')
            ->limit(10)
            ->get()
            ->toArray();

        return $this->view->render($response, 'condition/index.blade.php', [
            'dashboard' => $dashboard,
            'priorities' => $priorities,
            'recentEvents' => $recentEvents,
            'upcomingAssessments' => $upcomingAssessments,
            'pageTitle' => 'Condition Dashboard',
        ]);
    }

    /**
     * List Condition Reports for Object
     * Route: GET /{slug}/condition
     */
    public function show(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $events = ConditionEventService::getObjectEvents($object->id);
        $latestCondition = ConditionEventService::getLatestCondition($object->id);
        $conservationHistory = ConditionEventService::getConservationHistory($object->id);
        $riskScore = ConditionRiskService::calculateRiskScore($object->id);
        $assessmentSchedule = ConditionRiskService::getAssessmentSchedule($object->id);

        return $this->view->render($response, 'condition/show.blade.php', [
            'object' => $object,
            'events' => $events,
            'latestCondition' => $latestCondition,
            'conservationHistory' => $conservationHistory,
            'riskScore' => $riskScore,
            'assessmentSchedule' => $assessmentSchedule,
            'pageTitle' => 'Condition Report - ' . ($object->title ?? $object->identifier),
        ]);
    }

    /**
     * New Condition Event Form
     * Route: GET /{slug}/condition/new
     */
    public function create(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $vocabularies = [
            'damage_types' => ConditionVocabularyService::getDamageTypes(),
            'severity_levels' => ConditionVocabularyService::getSeverityLevels(),
            'material_types' => ConditionVocabularyService::getMaterialTypes(),
            'location_zones' => ConditionVocabularyService::getLocationZones(),
            'event_types' => ConditionVocabularyService::getEventTypes(),
            'condition_terms' => ConditionVocabularyService::getConditionTerms(),
        ];

        $templates = DB::table('condition_report_template')
            ->where('active', 1)
            ->orderBy('name')
            ->get()
            ->toArray();

        return $this->view->render($response, 'condition/create.blade.php', [
            'object' => $object,
            'vocabularies' => $vocabularies,
            'templates' => $templates,
            'pageTitle' => 'New Condition Report - ' . ($object->title ?? $object->identifier),
        ]);
    }

    /**
     * Store Condition Event
     * Route: POST /{slug}/condition
     */
    public function store(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $data = $request->getParsedBody();
        $currentUser = $request->getAttribute('user');

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $eventData = [
            'object_id' => $object->id,
            'event_type' => $data['event_type'] ?? 'condition_check',
            'condition_rating' => $data['condition_rating'] ?? null,
            'overall_condition' => $data['overall_condition'] ?? null,
            'damage_type' => $data['damage_type'] ?? null,
            'severity' => $data['severity'] ?? null,
            'location_on_object' => $data['location_on_object'] ?? null,
            'material_type' => $data['material_type'] ?? null,
            'description' => $data['description'] ?? null,
            'treatment_required' => isset($data['treatment_required']) ? 1 : 0,
            'treatment_priority' => $data['treatment_priority'] ?? null,
            'treatment_recommended' => $data['treatment_recommended'] ?? null,
            'environmental_factors' => $data['environmental_factors'] ?? null,
            'handling_requirements' => $data['handling_requirements'] ?? null,
            'storage_requirements' => $data['storage_requirements'] ?? null,
            'display_requirements' => $data['display_requirements'] ?? null,
            'event_date' => $data['event_date'] ?? date('Y-m-d'),
            'assessor_id' => $currentUser['id'] ?? 0,
            'metadata' => !empty($data['metadata']) ? json_encode($data['metadata']) : null,
        ];

        $eventId = ConditionEventService::createEvent($eventData);

        if ($eventId) {
            // Update risk score
            ConditionRiskService::updateRiskScore($object->id);

            // Schedule next assessment if needed
            if (!empty($data['next_assessment_date'])) {
                ConditionRiskService::scheduleAssessment(
                    $object->id,
                    $data['next_assessment_date'],
                    $data['assessment_frequency'] ?? 'annual',
                    $data['assessment_notes'] ?? null
                );
            }

            return $this->redirect($response, "/{$slug}/condition?success=created");
        }

        return $this->redirect($response, "/{$slug}/condition/new?error=failed");
    }

    /**
     * View Single Condition Event
     * Route: GET /{slug}/condition/{eventId}
     */
    public function view(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $eventId = (int) $args['eventId'];

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $event = ConditionEventService::getEvent($eventId);

        if (!$event || $event->object_id !== $object->id) {
            return $this->redirect($response, "/{$slug}/condition?error=notfound");
        }

        $annotations = DB::table('condition_annotation')
            ->where('event_id', $eventId)
            ->orderBy('created_at')
            ->get()
            ->toArray();

        return $this->view->render($response, 'condition/view.blade.php', [
            'object' => $object,
            'event' => $event,
            'annotations' => $annotations,
            'pageTitle' => 'Condition Event - ' . ($object->title ?? $object->identifier),
        ]);
    }

    /**
     * Edit Condition Event
     * Route: GET /{slug}/condition/{eventId}/edit
     */
    public function edit(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $eventId = (int) $args['eventId'];

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $event = ConditionEventService::getEvent($eventId);

        if (!$event || $event->object_id !== $object->id) {
            return $this->redirect($response, "/{$slug}/condition?error=notfound");
        }

        $vocabularies = [
            'damage_types' => ConditionVocabularyService::getDamageTypes(),
            'severity_levels' => ConditionVocabularyService::getSeverityLevels(),
            'material_types' => ConditionVocabularyService::getMaterialTypes(),
            'location_zones' => ConditionVocabularyService::getLocationZones(),
            'event_types' => ConditionVocabularyService::getEventTypes(),
            'condition_terms' => ConditionVocabularyService::getConditionTerms(),
        ];

        return $this->view->render($response, 'condition/edit.blade.php', [
            'object' => $object,
            'event' => $event,
            'vocabularies' => $vocabularies,
            'pageTitle' => 'Edit Condition Event - ' . ($object->title ?? $object->identifier),
        ]);
    }

    /**
     * Update Condition Event
     * Route: PUT /{slug}/condition/{eventId}
     */
    public function update(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $eventId = (int) $args['eventId'];
        $data = $request->getParsedBody();
        $currentUser = $request->getAttribute('user');

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $updateData = [
            'event_type' => $data['event_type'] ?? null,
            'condition_rating' => $data['condition_rating'] ?? null,
            'overall_condition' => $data['overall_condition'] ?? null,
            'damage_type' => $data['damage_type'] ?? null,
            'severity' => $data['severity'] ?? null,
            'location_on_object' => $data['location_on_object'] ?? null,
            'material_type' => $data['material_type'] ?? null,
            'description' => $data['description'] ?? null,
            'treatment_required' => isset($data['treatment_required']) ? 1 : 0,
            'treatment_priority' => $data['treatment_priority'] ?? null,
            'treatment_recommended' => $data['treatment_recommended'] ?? null,
            'environmental_factors' => $data['environmental_factors'] ?? null,
            'handling_requirements' => $data['handling_requirements'] ?? null,
            'storage_requirements' => $data['storage_requirements'] ?? null,
            'display_requirements' => $data['display_requirements'] ?? null,
        ];

        $success = ConditionEventService::updateEvent($eventId, $updateData, $currentUser['id'] ?? 0);

        if ($success) {
            ConditionRiskService::updateRiskScore($object->id);

            return $this->redirect($response, "/{$slug}/condition/{$eventId}?success=updated");
        }

        return $this->redirect($response, "/{$slug}/condition/{$eventId}/edit?error=failed");
    }

    /**
     * Conservation Treatment Form
     * Route: GET /{slug}/condition/treatment/new
     */
    public function createTreatment(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $treatmentTypes = ConditionVocabularyService::getTreatmentTypes();
        $recentEvents = ConditionEventService::getObjectEvents($object->id, 5);

        return $this->view->render($response, 'condition/treatment_create.blade.php', [
            'object' => $object,
            'treatmentTypes' => $treatmentTypes,
            'recentEvents' => $recentEvents,
            'pageTitle' => 'New Conservation Treatment - ' . ($object->title ?? $object->identifier),
        ]);
    }

    /**
     * Store Conservation Treatment
     * Route: POST /{slug}/condition/treatment
     */
    public function storeTreatment(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $data = $request->getParsedBody();
        $currentUser = $request->getAttribute('user');

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        $treatmentData = [
            'object_id' => $object->id,
            'treatment_type' => $data['treatment_type'],
            'treatment_date' => $data['treatment_date'] ?? date('Y-m-d'),
            'conservator' => $data['conservator'] ?? null,
            'description' => $data['description'],
            'materials_used' => $data['materials_used'] ?? null,
            'before_condition' => $data['before_condition'] ?? null,
            'after_condition' => $data['after_condition'] ?? null,
            'cost' => !empty($data['cost']) ? (float) $data['cost'] : null,
            'duration_hours' => !empty($data['duration_hours']) ? (float) $data['duration_hours'] : null,
            'notes' => $data['notes'] ?? null,
            'performed_by' => $currentUser['id'] ?? 0,
        ];

        $treatmentId = ConditionEventService::recordTreatment($treatmentData);

        if ($treatmentId) {
            // Create a condition event for this treatment
            $eventData = [
                'object_id' => $object->id,
                'event_type' => 'conservation_treatment',
                'description' => "Conservation treatment: {$data['treatment_type']}",
                'overall_condition' => $data['after_condition'] ?? null,
                'event_date' => $data['treatment_date'] ?? date('Y-m-d'),
                'assessor_id' => $currentUser['id'] ?? 0,
                'metadata' => json_encode(['treatment_id' => $treatmentId]),
            ];
            ConditionEventService::createEvent($eventData);

            ConditionRiskService::updateRiskScore($object->id);

            return $this->redirect($response, "/{$slug}/condition?success=treatment_recorded");
        }

        return $this->redirect($response, "/{$slug}/condition/treatment/new?error=failed");
    }

    /**
     * Risk Assessment
     * Route: GET /admin/condition/risk
     */
    public function riskAssessment(Request $request, Response $response): Response
    {
        $params = $request->getQueryParams();
        $page = (int) ($params['page'] ?? 1);
        $perPage = 25;
        $minScore = !empty($params['min_score']) ? (float) $params['min_score'] : null;

        $query = DB::table('condition_risk_score as crs')
            ->join('information_object as io', 'crs.object_id', '=', 'io.id')
            ->leftJoin('information_object_i18n as ioi', function ($join) {
                $join->on('io.id', '=', 'ioi.id')
                    ->where('ioi.culture', '=', 'en');
            })
            ->leftJoin('slug', 'io.id', '=', 'slug.object_id')
            ->select([
                'crs.*',
                'ioi.title',
                'io.identifier',
                'slug.slug',
            ]);

        if ($minScore !== null) {
            $query->where('crs.risk_score', '>=', $minScore);
        }

        $total = $query->count();

        $items = $query
            ->orderBy('crs.risk_score', 'desc')
            ->offset(($page - 1) * $perPage)
            ->limit($perPage)
            ->get()
            ->toArray();

        $dashboard = ConditionRiskService::getDashboardSummary();

        return $this->view->render($response, 'condition/risk.blade.php', [
            'items' => $items,
            'total' => $total,
            'page' => $page,
            'perPage' => $perPage,
            'minScore' => $minScore,
            'dashboard' => $dashboard,
            'pageTitle' => 'Risk Assessment',
        ]);
    }

    /**
     * Vocabulary Management
     * Route: GET /admin/condition/vocabularies
     */
    public function vocabularies(Request $request, Response $response): Response
    {
        $vocabularies = [
            'damage_types' => ConditionVocabularyService::getDamageTypes(false),
            'severity_levels' => ConditionVocabularyService::getSeverityLevels(false),
            'material_types' => ConditionVocabularyService::getMaterialTypes(false),
            'location_zones' => ConditionVocabularyService::getLocationZones(false),
            'event_types' => ConditionVocabularyService::getEventTypes(false),
            'condition_terms' => ConditionVocabularyService::getConditionTerms(false),
            'treatment_types' => ConditionVocabularyService::getTreatmentTypes(false),
        ];

        return $this->view->render($response, 'condition/vocabularies.blade.php', [
            'vocabularies' => $vocabularies,
            'pageTitle' => 'Condition Vocabularies',
        ]);
    }

    /**
     * Add Vocabulary Term
     * Route: POST /admin/condition/vocabularies/add
     */
    public function addVocabularyTerm(Request $request, Response $response): Response
    {
        $data = $request->getParsedBody();

        $termData = [
            'vocabulary_type' => $data['vocabulary_type'],
            'code' => $data['code'],
            'name' => $data['name'],
            'description' => $data['description'] ?? null,
            'sort_order' => !empty($data['sort_order']) ? (int) $data['sort_order'] : 0,
            'multiplier' => !empty($data['multiplier']) ? (float) $data['multiplier'] : 1.0,
        ];

        $id = ConditionVocabularyService::addTerm($termData);

        if ($id) {
            return $this->redirect($response, '/admin/condition/vocabularies?success=added');
        }

        return $this->redirect($response, '/admin/condition/vocabularies?error=failed');
    }

    /**
     * Initialize Default Vocabularies
     * Route: POST /admin/condition/vocabularies/initialize
     */
    public function initializeVocabularies(Request $request, Response $response): Response
    {
        $count = ConditionVocabularyService::initializeDefaultVocabularies();

        return $this->redirect($response, "/admin/condition/vocabularies?success=initialized&count={$count}");
    }

    /**
     * Export Condition Report
     * Route: GET /{slug}/condition/export
     */
    public function export(Request $request, Response $response, array $args): Response
    {
        $slug = $args['slug'];
        $params = $request->getQueryParams();
        $format = $params['format'] ?? 'json';

        $object = $this->getObjectBySlug($slug);

        if (!$object) {
            return $this->redirect($response, '/?error=notfound');
        }

        if ('iiif-annotation' === $format) {
            $export = ConditionExportService::exportAsIiifAnnotation($object->id);
            $response->getBody()->write(json_encode($export, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));

            return $response
                ->withHeader('Content-Type', 'application/ld+json')
                ->withHeader('Content-Disposition', "attachment; filename=\"condition-annotations-{$slug}.json\"");
        }

        if ('iiif-manifest' === $format) {
            $export = ConditionExportService::exportAsIiifManifest($object->id);
            $response->getBody()->write(json_encode($export, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));

            return $response
                ->withHeader('Content-Type', 'application/ld+json')
                ->withHeader('Content-Disposition', "attachment; filename=\"condition-manifest-{$slug}.json\"");
        }

        if ('preservation-package' === $format) {
            $export = ConditionExportService::createPreservationPackage($object->id);
            $response->getBody()->write(json_encode($export, JSON_PRETTY_PRINT));

            return $response
                ->withHeader('Content-Type', 'application/json')
                ->withHeader('Content-Disposition', "attachment; filename=\"preservation-package-{$slug}.json\"");
        }

        // Default: Full condition report
        $export = [
            'object' => $object,
            'events' => ConditionEventService::getObjectEvents($object->id),
            'latest_condition' => ConditionEventService::getLatestCondition($object->id),
            'conservation_history' => ConditionEventService::getConservationHistory($object->id),
            'risk_score' => ConditionRiskService::calculateRiskScore($object->id),
            'exported_at' => date('c'),
        ];

        $response->getBody()->write(json_encode($export, JSON_PRETTY_PRINT));

        return $response
            ->withHeader('Content-Type', 'application/json')
            ->withHeader('Content-Disposition', "attachment; filename=\"condition-report-{$slug}.json\"");
    }

    /**
     * Assessment Schedule Management
     * Route: GET /admin/condition/schedule
     */
    public function scheduleList(Request $request, Response $response): Response
    {
        $params = $request->getQueryParams();
        $page = (int) ($params['page'] ?? 1);
        $perPage = 25;
        $period = $params['period'] ?? '30'; // Days

        $query = DB::table('condition_assessment_schedule as cas')
            ->join('information_object as io', 'cas.object_id', '=', 'io.id')
            ->leftJoin('information_object_i18n as ioi', function ($join) {
                $join->on('io.id', '=', 'ioi.id')
                    ->where('ioi.culture', '=', 'en');
            })
            ->leftJoin('slug', 'io.id', '=', 'slug.object_id')
            ->where('cas.next_assessment_date', '>=', date('Y-m-d'))
            ->where('cas.next_assessment_date', '<=', date('Y-m-d', strtotime("+{$period} days")))
            ->select([
                'cas.*',
                'ioi.title',
                'io.identifier',
                'slug.slug',
            ]);

        $total = $query->count();

        $items = $query
            ->orderBy('cas.next_assessment_date')
            ->offset(($page - 1) * $perPage)
            ->limit($perPage)
            ->get()
            ->toArray();

        // Overdue assessments
        $overdue = DB::table('condition_assessment_schedule as cas')
            ->join('information_object as io', 'cas.object_id', '=', 'io.id')
            ->leftJoin('information_object_i18n as ioi', function ($join) {
                $join->on('io.id', '=', 'ioi.id')
                    ->where('ioi.culture', '=', 'en');
            })
            ->leftJoin('slug', 'io.id', '=', 'slug.object_id')
            ->where('cas.next_assessment_date', '<', date('Y-m-d'))
            ->select([
                'cas.*',
                'ioi.title',
                'io.identifier',
                'slug.slug',
            ])
            ->orderBy('cas.next_assessment_date')
            ->get()
            ->toArray();

        return $this->view->render($response, 'condition/schedule.blade.php', [
            'items' => $items,
            'overdue' => $overdue,
            'total' => $total,
            'page' => $page,
            'perPage' => $perPage,
            'period' => $period,
            'pageTitle' => 'Assessment Schedule',
        ]);
    }

    /**
     * Get Object by Slug
     */
    private function getObjectBySlug(string $slug): ?object
    {
        return DB::table('information_object as io')
            ->join('slug', 'io.id', '=', 'slug.object_id')
            ->leftJoin('information_object_i18n as ioi', function ($join) {
                $join->on('io.id', '=', 'ioi.id')
                    ->where('ioi.culture', '=', 'en');
            })
            ->where('slug.slug', $slug)
            ->select(['io.*', 'ioi.title', 'slug.slug'])
            ->first();
    }

    /**
     * Redirect Helper
     */
    private function redirect(Response $response, string $url): Response
    {
        return $response
            ->withHeader('Location', $url)
            ->withStatus(302);
    }
}
