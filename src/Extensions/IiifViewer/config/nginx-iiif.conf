# =====================================================
# IIIF Viewer Framework - Nginx Configuration
# 
# Add this to your AtoM server block in nginx.conf
# Location: /etc/nginx/sites-available/atom
#
# @author Johan Pieterse - The Archive and Heritage Group
# @version 1.0.0
# =====================================================

# =====================================================
# IIIF Manifest & API Routes
# =====================================================

# Object manifest: /iiif/manifest/{slug}
location ~ ^/iiif/manifest/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    # CORS headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
    
    # IIIF content type
    add_header 'Content-Type' 'application/ld+json;profile="http://iiif.io/api/presentation/3/context.json"';
}

# Collection manifest: /iiif/collection/{slug}
location ~ ^/iiif/collection/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
}

# List manifests: /iiif/list/{slug}
location ~ ^/iiif/list/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# Annotations API: /iiif/annotations/*
location ~ ^/iiif/annotations {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
    
    # Handle preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }
}

# OCR endpoints: /iiif/ocr/*
location ~ ^/iiif/ocr {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# Text content: /iiif/text/*
location ~ ^/iiif/text {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Content-Type' 'text/plain; charset=utf-8';
}

# Content search: /iiif/search/*
location ~ ^/iiif/search {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# Viewer HTML: /iiif/viewer/*
location ~ ^/iiif/viewer {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
}

# Embed viewer: /iiif/embed/*
location ~ ^/iiif/embed {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
}

# 3D model manifest: /iiif/3d/{id}/manifest.json
location ~ ^/iiif/3d/(\d+)/manifest\.json$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Content-Type' 'application/ld+json';
}

# =====================================================
# Legacy manifest endpoint (backward compatibility)
# =====================================================

location = /iiif-manifest.php {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/routes.php?$query_string;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
}

# =====================================================
# Cantaloupe IIIF Image Server Proxy
# =====================================================

location /iiif/2/ {
    proxy_pass http://127.0.0.1:8182/iiif/2/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS for IIIF images
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    
    # Cache settings
    proxy_cache_valid 200 1d;
    proxy_cache_valid 404 1m;
    
    # Large image timeout
    proxy_read_timeout 300;
    proxy_connect_timeout 60;
}

# =====================================================
# Static Assets for Viewers
# =====================================================

# Framework static files
location /atom-framework/src/Extensions/IiifViewer/public/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/public/;
    expires 7d;
    add_header Cache-Control "public, immutable";
    
    # Enable CORS for JS modules
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# Mirador viewer files
location /atom-framework/src/Extensions/IiifViewer/public/viewers/mirador/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/public/viewers/mirador/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# OpenSeadragon viewer files
location /atom-framework/src/Extensions/IiifViewer/public/viewers/openseadragon/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/public/viewers/openseadragon/;
    expires 30d;
}

# Annotorious files
location /atom-framework/src/Extensions/IiifViewer/public/viewers/annotorious/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/public/viewers/annotorious/;
    expires 30d;
}

# =====================================================
# 3D Model Files
# =====================================================

location /uploads/3d/ {
    alias /usr/share/nginx/archive/uploads/3d/;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    
    # MIME types for 3D models
    types {
        model/gltf-binary glb;
        model/gltf+json gltf;
        model/obj obj;
        model/stl stl;
        model/vnd.usdz+zip usdz;
    }
}

# =====================================================
# Security Headers
# =====================================================

# Content Security Policy for viewers
# Note: Adjust as needed for your environment
location ~ ^/iiif/(viewer|embed) {
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://ajax.googleapis.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com; img-src 'self' data: blob: https:; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https:; frame-src 'self' https:;";
}
