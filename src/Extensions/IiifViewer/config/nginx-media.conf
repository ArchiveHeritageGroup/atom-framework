# =====================================================
# IIIF Viewer Framework - Nginx Configuration
# 
# Add this to your AtoM server block in nginx.conf:
# include /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/config/nginx-iiif.conf;
#
# @author Johan Pieterse - The Archive and Heritage Group
# @version 2.0.0
# =====================================================

# =====================================================
# IIIF API Routes
# =====================================================

# Main IIIF router - handles all /iiif/* requests
location ~ ^/iiif/(manifest|collection|list|annotations|ocr|text|search|viewer|embed|transcription|3d)/(.*)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    # CORS headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
    
    # Cache manifests
    add_header 'Cache-Control' 'public, max-age=3600';
    
    # PHP handling
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# =====================================================
# Media API Routes (Metadata & Transcription)
# =====================================================

# Media metadata extraction
location ~ ^/media/(metadata|extract|waveform)/(\d+)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# Transcription endpoints
location ~ ^/media/(transcription|transcribe)/(\d+)(.*)$ {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    
    # Longer timeout for transcription processing
    fastcgi_read_timeout 600;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# Media search
location ~ ^/media/search {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# Media queue and batch operations
location ~ ^/media/(queue|batch|status) {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# =====================================================
# Media Static Files
# =====================================================

# Waveform images
location /uploads/waveforms/ {
    alias /usr/share/nginx/archive/uploads/waveforms/;
    expires 30d;
    add_header 'Cache-Control' 'public, immutable';
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# Transcript files (VTT, SRT, TXT)
location /uploads/transcripts/ {
    alias /usr/share/nginx/archive/uploads/transcripts/;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    
    # Set content types
    location ~ \.vtt$ {
        add_header 'Content-Type' 'text/vtt; charset=utf-8';
    }
    location ~ \.srt$ {
        add_header 'Content-Type' 'text/plain; charset=utf-8';
    }
    location ~ \.txt$ {
        add_header 'Content-Type' 'text/plain; charset=utf-8';
    }
}

# =====================================================
# Legacy manifest endpoint (backward compatibility)
# =====================================================

location = /iiif-manifest.php {
    try_files $uri /atom-framework/src/Extensions/IiifViewer/public/router.php?$args;
    
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# =====================================================
# Cantaloupe IIIF Image Server Proxy
# =====================================================

location /iiif/2/ {
    proxy_pass http://127.0.0.1:8182/iiif/2/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    
    # Cache settings
    proxy_cache_valid 200 1d;
    proxy_cache_valid 404 1m;
    
    # Large image timeout
    proxy_read_timeout 300;
    proxy_connect_timeout 60;
}

# =====================================================
# Static Assets for Viewers
# =====================================================

# Framework static files
location /atom-framework/src/Extensions/IiifViewer/public/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/IiifViewer/public/;
    expires 7d;
    add_header 'Cache-Control' 'public, immutable';
    add_header 'Access-Control-Allow-Origin' '*' always;
}

# =====================================================
# 3D Model Files (standard uploads)
# =====================================================

# 3D models served from standard uploads directory
location ~ \.(glb|gltf|obj|stl|fbx|ply|usdz)$ {
    add_header 'Access-Control-Allow-Origin' '*' always;
    
    # MIME types for 3D models
    types {
        model/gltf-binary glb;
        model/gltf+json gltf;
        model/obj obj;
        model/stl stl;
        application/x-fbx fbx;
        model/ply ply;
        model/vnd.usdz+zip usdz;
    }
}

# =====================================================
# OPTIONS Preflight Handling
# =====================================================

location ~ ^/(iiif|media)/ {
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }
}
