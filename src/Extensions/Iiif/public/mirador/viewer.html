<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIIF 3.0 Viewer - The Archive and Heritage Group</title>
    <link rel="stylesheet" href="mirador.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #mirador-viewer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: #666;
        }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: #d32f2f;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        .error h2 {
            margin-bottom: 10px;
        }
        .error a {
            color: #1a73e8;
        }
    </style>
</head>
<body>
    <div id="mirador-viewer">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading IIIF 3.0 Viewer...</div>
        </div>
    </div>

    <script src="mirador.min.js"></script>
    <script>
        (function() {
            // Get manifest URL from query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const manifestUrl = urlParams.get('manifest');
            
            if (!manifestUrl) {
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <h2>No Manifest URL</h2>
                        <p>Please provide a manifest URL using the <code>?manifest=</code> parameter.</p>
                        <p style="margin-top:10px">
                            <a href="/">Return to Archive</a>
                        </p>
                    </div>
                `;
                return;
            }
            
            // Update page title
            document.title = 'IIIF Viewer - ' + decodeURIComponent(manifestUrl).split('/').pop();
            
            // Initialize Mirador 3
            try {
                const mirador = Mirador.viewer({
                    id: 'mirador-viewer',
                    windows: [
                        {
                            manifestId: manifestUrl,
                            thumbnailNavigationPosition: 'far-bottom'
                        }
                    ],
                    window: {
                        allowClose: false,
                        allowMaximize: true,
                        defaultSideBarPanel: 'info',
                        sideBarOpenByDefault: false,
                        panels: {
                            info: true,
                            attribution: true,
                            canvas: true,
                            annotations: true,
                            search: true,
                            layers: true
                        }
                    },
                    workspace: {
                        showZoomControls: true,
                        type: 'mosaic',
                        allowNewWindows: true
                    },
                    workspaceControlPanel: {
                        enabled: true
                    },
                    thumbnailNavigation: {
                        defaultPosition: 'far-bottom',
                        displaySettings: true,
                        height: 130
                    },
                    // IIIF 3.0 configuration
                    osdConfig: {
                        gestureSettingsMouse: {
                            scrollToZoom: true
                        },
                        gestureSettingsTouch: {
                            pinchRotate: true
                        }
                    }
                });
                
                // Remove loading indicator once Mirador is initialized
                setTimeout(function() {
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }, 1000);
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <h2>Viewer Error</h2>
                        <p>${error.message}</p>
                        <p style="margin-top:10px">
                            <a href="/">Return to Archive</a>
                        </p>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>
