# =====================================================
# IIIF 3.0 Presentation API Routes
# Add to nginx server block for archives.theahg.co.za
# 
# All routes handled by atom-framework
# =====================================================

# IIIF 3.0 Object Manifest
# URL: /iiif/manifest/{slug}
location ~ ^/iiif/manifest/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/Iiif/public/iiif-routes.php?$args;
    
    fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/iiif-routes.php;
    include fastcgi_params;
}

# IIIF 3.0 Collection Manifest  
# URL: /iiif/collection/{slug}
location ~ ^/iiif/collection/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/Iiif/public/iiif-routes.php?$args;
    
    fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/iiif-routes.php;
    include fastcgi_params;
}

# IIIF List Manifests
# URL: /iiif/list/{slug}
location ~ ^/iiif/list/(.+)$ {
    try_files $uri /atom-framework/src/Extensions/Iiif/public/iiif-routes.php?$args;
    
    fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/iiif-routes.php;
    include fastcgi_params;
}

# Legacy manifest endpoint (still supported, now uses framework)
# URL: /iiif-manifest.php?id={identifier}
location = /iiif-manifest.php {
    fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/iiif-routes.php;
    include fastcgi_params;
}

# IIIF 3D Manifest (from ahg3DModelPlugin via framework)
# URL: /iiif/3d/{id}/manifest.json
location ~ ^/iiif/3d/(\d+)/manifest\.json$ {
    try_files $uri /index.php?module=ar3DModel&action=iiifManifest&id=$1;
}

# Mirador viewer files (static)
location /atom-framework/src/Extensions/Iiif/public/mirador/ {
    alias /usr/share/nginx/archive/atom-framework/src/Extensions/Iiif/public/mirador/;
    expires 7d;
    add_header Cache-Control "public, immutable";
}

# Cantaloupe Image API Proxy
# URL: /iiif/2/{identifier}/{region}/{size}/{rotation}/{quality}.{format}
location /iiif/2/ {
    proxy_pass http://127.0.0.1:8182/iiif/2/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS headers for IIIF
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
}
