#
# Heratio (AtoM AHG Framework) — Full Nginx Configuration
# =========================================================
# Include this file in your nginx server block to route AHG
# plugin traffic through the Laravel-based Heratio entry point.
#
# Usage in your nginx config:
#   include /path/to/atom-framework/config/nginx/heratio.conf;
#
# Place this BEFORE the main PHP handler (index.php) block.
#
# KILL-SWITCH: Heratio is gated by a flag file. When the flag
# file is absent, ALL routes fall through to Symfony's index.php.
# Toggle instantly — no nginx reload required.
#
#   Enable:   touch /usr/share/nginx/archive/.heratio_enabled
#   Disable:  rm /usr/share/nginx/archive/.heratio_enabled
#
# The env var HERATIO_ENABLED (checked by heratio.php) provides
# a second layer of protection at the application level.
#
# Updated: 2026-02-13
#

# ── Kill-Switch: flag file gate ──────────────────────────
# When .heratio_enabled exists → route to heratio.php
# When absent → route to index.php (Symfony handles everything)
set $heratio_entry "index.php";
if (-f $document_root/.heratio_enabled) {
    set $heratio_entry "heratio.php";
}

# ======================================
# API V3 ENDPOINTS (Laravel/Heratio)
# ======================================

location ~ ^/api/v3/ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ======================================
# AUTH ENDPOINTS (Laravel/Heratio)
# ======================================

location ~ ^/auth/ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ======================================
# AHG PLUGIN ROUTES (Laravel/Heratio)
# ======================================

# ── Settings, Audit, TTS ────────────────────────────────
location ~ ^/(ahgSettings|admin/ahg-settings|settings|admin/audit|tts)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── GLAM Browse, Display Search ──────────────────────────
location ~ ^/(glam|display)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Security, Access Requests ────────────────────────────
location ~ ^/(security|accessRequest)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Heritage Platform ────────────────────────────────────
location ~ ^/heritage(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── AI & NER ─────────────────────────────────────────────
location ~ ^/(ai|ner)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Data Migration, ICIP, RiC ───────────────────────────
location ~ ^/(dataMigration|admin/data-migration|icip|admin/ric|ricExplorer)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Provenance, Feedback, Cart ───────────────────────────
location ~ ^/(provenance|feedback|cart)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Metadata Extraction, Semantic Search ─────────────────
location ~ ^/(metadataExtraction|admin/semantic-search|semanticSearchAdmin)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Multi-Tenant ─────────────────────────────────────────
location ~ ^/tenant(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Admin: report-builder, backup ────────────────────────
# DISABLED — routes through Symfony until Heratio action resolution is complete
# location ~ ^/admin/(report-builder|backup)(/|$) {
#     include fastcgi_params;
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
#     fastcgi_param SCRIPT_NAME /$heratio_entry;
#     fastcgi_param REQUEST_URI $request_uri;
#     fastcgi_read_timeout 300;
# }

# ── Research ─────────────────────────────────────────────
location ~ ^/research(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ══════════════════════════════════════════════════════════
# AHG MANAGE PLUGIN ROUTES
# ══════════════════════════════════════════════════════════
#
# These are AHG plugin modules that use AhgController and
# render via Blade templates + Laravel DB. They work fully
# in standalone Heratio mode.
#
location ~ ^/(accessionManage|actorManage|donorManage|repositoryManage|rightsHolderManage|storageManage|termTaxonomy|userManage)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Spectrum, Preservation, Reports ──────────────────────
location ~ ^/(spectrum|preservation|reports|condition)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Privacy, Extended Rights, Vendor, Contact ────────────
location ~ ^/(privacy|extendedRights|vendor|contact|donorAgreement)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── DOI, Favorites, Feedback, Publish ────────────────────
location ~ ^/(doi|favorites|requestToPublish)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Jobs, Static Pages, Menu Management ──────────────────
location ~ ^/(jobsManage|staticPageManage|menuManage|digitalObjectManage)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ══════════════════════════════════════════════════════════
# CATCH-ALL: Route ALL /index.php through Heratio
# ══════════════════════════════════════════════════════════
#
# DISABLED — base AtoM sfAction modules (actor, repository,
# informationobject, staticpage, etc.) require full Propel +
# Symfony which isn't available in standalone Heratio mode.
# These routes continue to be handled by Symfony's index.php.
#
# Uncomment when full Propel compatibility is achieved:
#
# location ~ ^/index\.php(/|$) {
#     include fastcgi_params;
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
#     fastcgi_param SCRIPT_NAME /$heratio_entry;
#     fastcgi_param REQUEST_URI $request_uri;
#     fastcgi_read_timeout 300;
#     fastcgi_buffer_size 128k;
#     fastcgi_buffers 4 256k;
#     fastcgi_busy_buffers_size 256k;
# }
