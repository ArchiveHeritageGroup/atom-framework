#
# Heratio (AtoM AHG Framework) — Full Nginx Configuration
# =========================================================
# Include this file in your nginx server block to route AHG
# plugin traffic through the Laravel-based Heratio entry point.
#
# Usage in your nginx config:
#   include /path/to/atom-framework/config/nginx/heratio.conf;
#
# Place this BEFORE the main PHP handler (index.php) block.
#
# KILL-SWITCH: Heratio is gated by a flag file. When the flag
# file is absent, ALL routes fall through to Symfony's index.php.
# Toggle instantly — no nginx reload required.
#
#   Enable:   touch /usr/share/nginx/archive/.heratio_enabled
#   Disable:  rm /usr/share/nginx/archive/.heratio_enabled
#
# The env var HERATIO_ENABLED (checked by heratio.php) provides
# a second layer of protection at the application level.
#
# Updated: 2026-02-13
#

# ── Kill-Switch: flag file gate ──────────────────────────
# When .heratio_enabled exists → route to heratio.php
# When absent → route to index.php (Symfony handles everything)
set $heratio_entry "index.php";
if (-f $document_root/.heratio_enabled) {
    set $heratio_entry "heratio.php";
}

# ======================================
# ROOT URL — redirect to heritage (standalone mode only)
# ======================================
# Uncomment when running in standalone mode:
# location = / {
#     return 302 /heritage;
# }

# ======================================
# API V3 ENDPOINTS (Laravel/Heratio)
# ======================================

location ~ ^/api/v3/ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ======================================
# AUTH ENDPOINTS (Laravel/Heratio)
# ======================================

location ~ ^/auth/ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ======================================
# USER AUTH (login/logout/clipboard)
# ======================================

location ~ ^/user(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ======================================
# AHG PLUGIN ROUTES (Laravel/Heratio)
# ======================================

# ── Settings, Audit, TTS ────────────────────────────────
location ~ ^/(ahgSettings|admin/ahg-settings|settings|admin/audit|tts)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── GLAM Browse, Display Search ──────────────────────────
location ~ ^/(glam|display)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Security, Access Requests ────────────────────────────
location ~ ^/(security|accessRequest)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Heritage Platform ────────────────────────────────────
location ~ ^/heritage(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── AI & NER ─────────────────────────────────────────────
location ~ ^/(ai|ner)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Data Migration, ICIP, RiC ───────────────────────────
location ~ ^/(dataMigration|admin/data-migration|icip|admin/ric|ricExplorer)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Provenance, Feedback, Cart ───────────────────────────
location ~ ^/(provenance|feedback|cart)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Metadata Extraction, Semantic Search ─────────────────
location ~ ^/(metadataExtraction|admin/semantic-search|semanticSearchAdmin)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Multi-Tenant ─────────────────────────────────────────
location ~ ^/tenant(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Admin: report-builder, backup ────────────────────────
# DISABLED — routes through Symfony until Heratio action resolution is complete
# location ~ ^/admin/(report-builder|backup)(/|$) {
#     include fastcgi_params;
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
#     fastcgi_param SCRIPT_NAME /$heratio_entry;
#     fastcgi_param REQUEST_URI $request_uri;
#     fastcgi_read_timeout 300;
# }

# ── Research ─────────────────────────────────────────────
location ~ ^/research(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ══════════════════════════════════════════════════════════
# AHG MANAGE PLUGIN ROUTES
# ══════════════════════════════════════════════════════════
#
# These are AHG plugin modules that use AhgController and
# render via Blade templates + Laravel DB. They work fully
# in standalone Heratio mode.
#
location ~ ^/(accessionManage|actorManage|donorManage|repositoryManage|rightsHolderManage|storageManage|termTaxonomy|userManage)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Spectrum, Preservation, Reports ──────────────────────
location ~ ^/(spectrum|preservation|reports|condition)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Privacy, Extended Rights, Vendor, Contact ────────────
location ~ ^/(privacy|extendedRights|vendor|contact|donorAgreement)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── DOI, Favorites, Feedback, Publish ────────────────────
location ~ ^/(doi|favorites|requestToPublish)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Jobs, Static Pages, Menu Management ──────────────────
location ~ ^/(jobsManage|staticPageManage|menuManage|digitalObjectManage)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ══════════════════════════════════════════════════════════
# BASE AtoM MODULE ROUTES (aliased to AHG manage plugins)
# ══════════════════════════════════════════════════════════
#
# These base AtoM module URLs are used in the menu database.
# ActionBridge redirects them to AHG manage plugin equivalents
# via ACTION_ALIASES (e.g., /actor/browse → actorManage/browse).
#
location ~ ^/(actor|repository|taxonomy|accession|donor|rightsholder|physicalobject|function|informationobject|term|aclGroup|staticpage|search|object|sfPluginAdminPlugin|sfSkosPlugin)(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ── Settings (base AtoM admin settings) ────────────────────
location ~ ^/settings(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}

# ══════════════════════════════════════════════════════════
# CATCH-ALL: Route ALL remaining requests through Heratio
# ══════════════════════════════════════════════════════════
#
# When .heratio_enabled exists, ALL requests go through
# heratio.php (standalone mode — Symfony not available).
# When absent, $heratio_entry = "index.php" and requests
# go through Symfony as normal.
#
# This MUST be the last location block before the main
# server catch-all, so static files (.css, .js, images)
# are still served directly by nginx.

# Catch-all for /index.php paths (intercepts try_files fallback)
#
# Flow: Request "/admin/secure" → no specific location match →
# main config's `location /` → `try_files $uri /index.php?$args` →
# internal redirect to /index.php → THIS block catches it →
# routes to $heratio_entry (heratio.php when standalone).
#
location ~ ^/index\.php(/|$) {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/$heratio_entry;
    fastcgi_param SCRIPT_NAME /$heratio_entry;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_read_timeout 300;
}
