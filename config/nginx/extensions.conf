#
# AtoM Framework - Optional Extension Nginx Configuration
# ========================================================
# Include this file in your nginx server block ONLY if you enable
# the IIIF Viewer or Media extensions.
#
# Usage in your nginx config:
#   include /path/to/atom-framework/config/nginx/extensions.conf;
#
# Place this BEFORE the main PHP handler and catch-all location blocks.
#

# ======================================
# MEDIA API ROUTES
# Required for: Media streaming, waveforms, transcription
# ======================================

# Main media routes
location ~ ^/media/ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Media/public/routes.php;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
}

# Media metadata, extraction, waveform
location ~ ^/media/(metadata|extract|waveform)/([0-9]+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# Transcription routes (longer timeout for processing)
location ~ ^/media/(transcription|transcribe)/([0-9]+)(.*)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    fastcgi_read_timeout 600;
    add_header Access-Control-Allow-Origin * always;
}

# Media search
location ~ ^/media/search {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# ======================================
# IIIF VIEWER ROUTES
# Required for: IIIF manifests, viewer, annotations, OCR, search
# ======================================

# IIIF Manifest generation
location ~ ^/iiif/manifest/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF Collection
location ~ ^/iiif/collection/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF Viewer
location ~ ^/iiif/viewer/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
}

# IIIF Embed
location ~ ^/iiif/embed/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
}

# IIIF Annotations
location ~ ^/iiif/annotations {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF OCR
location ~ ^/iiif/ocr {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
}

# IIIF Text
location ~ ^/iiif/text {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
}

# IIIF Search
location ~ ^/iiif/search {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
}

# IIIF Viewer static assets
location /atom-framework/src/Extensions/IiifViewer/public/ {
    alias $document_root/atom-framework/src/Extensions/IiifViewer/public/;
    expires 7d;
}

# ======================================
# IIIF IMAGE SERVER (CANTALOUPE) PROXY
# Required for: IIIF image tiles
# Requires Cantaloupe running on port 8182
# ======================================

# Uncomment these if you have Cantaloupe installed:
#
# location /iiif/ {
#     proxy_pass http://127.0.0.1:8182/iiif/;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     add_header Access-Control-Allow-Origin "*" always;
# }
#
# location = /iiif-manifest.php {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#     add_header Access-Control-Allow-Origin * always;
# }
