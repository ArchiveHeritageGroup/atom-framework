#
# AtoM Framework - Extension Nginx Configuration
# ========================================================
# Include this file in your nginx server block to enable
# media streaming, IIIF viewer, and other extension routes.
#
# Usage in your nginx config:
#   include /path/to/atom-framework/config/nginx/extensions.conf;
#
# Place this BEFORE the main PHP handler and catch-all location blocks.
#

# ======================================
# STATIC HTML TEST PAGES
# ======================================

location = /mirador-test.html {
    try_files $uri =404;
}

# ======================================
# MEDIA STREAMING & SNIPPETS (Symfony routes)
# Handled by the media module via Symfony routing
# ======================================

# Media streaming - pass through Symfony for transcoding support
# Buffering disabled for real-time streaming
location ~ ^/media/stream/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/stream/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/stream/$1;
    fastcgi_read_timeout 600;
    fastcgi_buffering off;
    add_header X-Accel-Buffering no;
}

# Media download
location ~ ^/media/download/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/download/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/download/$1;
}

# Media snippets - GET by digital_object_id query param
location = /media/snippets {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/snippets;
    fastcgi_param PATH_TRANSLATED $document_root/media/snippets;
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
}

# Media snippets by ID (GET/DELETE)
location ~ ^/media/snippets/([0-9]+)/delete$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/snippets/$1/delete;
    fastcgi_param PATH_TRANSLATED $document_root/media/snippets/$1/delete;
    add_header Access-Control-Allow-Origin * always;
}

# Media snippets by ID (list)
location ~ ^/media/snippets/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/snippets/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/snippets/$1;
    add_header Access-Control-Allow-Origin * always;
}

# ======================================
# IIIF MEDIA API ROUTES
# Metadata extraction, waveforms, transcription
# All routed through Symfony (ahgIiifPlugin)
# ======================================

# Media metadata extraction (POST)
location ~ ^/media/extract/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/extract/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/extract/$1;
    fastcgi_read_timeout 120;
    add_header Access-Control-Allow-Origin * always;
}

# Media metadata (GET)
location ~ ^/media/metadata/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/metadata/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/metadata/$1;
    add_header Access-Control-Allow-Origin * always;
}

# Transcription start (POST - longer timeout for processing)
location ~ ^/media/transcribe/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/transcribe/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/transcribe/$1;
    fastcgi_read_timeout 600;
    add_header Access-Control-Allow-Origin * always;
}

# Transcription data with format (GET - json/vtt/srt/txt)
location ~ ^/media/transcription/([0-9]+)/([a-z]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/transcription/$1/$2;
    fastcgi_param PATH_TRANSLATED $document_root/media/transcription/$1/$2;
    add_header Access-Control-Allow-Origin * always;
}

# Transcription data (GET - default json)
location ~ ^/media/transcription/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/transcription/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/transcription/$1;
    add_header Access-Control-Allow-Origin * always;
}

# ======================================
# IIIF VIEWER ROUTES
# Note: IIIF routes are handled by ahgIiifPlugin (Symfony)
# and configured in the main nginx config file.
# The routes below are disabled as they require router.php
# which is not currently implemented.
# ======================================

# IIIF Manifest generation - HANDLED BY MAIN CONFIG (ahgIiifPlugin via Symfony)
# location ~ ^/iiif/manifest/(.+)$ {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
#     add_header Access-Control-Allow-Origin * always;
# }

# IIIF Collection - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/collection/(.+)$ {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
#     add_header Access-Control-Allow-Origin * always;
# }

# IIIF Viewer - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/viewer/(.+)$ {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
# }

# IIIF Embed - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/embed/(.+)$ {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
# }

# IIIF Annotations - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/annotations {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
#     add_header Access-Control-Allow-Origin * always;
# }

# IIIF OCR - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/ocr {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
# }

# IIIF Text - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/text {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
# }

# IIIF Search - HANDLED BY MAIN CONFIG
# location ~ ^/iiif/search {
#     fastcgi_pass unix:/run/php/php8.3-fpm.sock;
#     include fastcgi_params;
#     fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/IiifViewer/public/router.php;
# }

# IIIF Viewer static assets
# Note: Using try_files instead of alias to avoid $document_root limitation
location /atom-framework/src/Extensions/IiifViewer/public/ {
    try_files $uri =404;
    expires 7d;
}

# ZoomPan static assets (CSS, JS, icons)
location /atom-framework/src/Extensions/ZoomPan/public/ {
    try_files $uri =404;
    expires 7d;
}

# ======================================
# IIIF IMAGE SERVER (CANTALOUPE) PROXY
# Requires Cantaloupe running on port 8182
# ======================================

# Uncomment if you have Cantaloupe installed:
# location /iiif/ {
#     proxy_pass http://127.0.0.1:8182/iiif/;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     add_header Access-Control-Allow-Origin "*" always;
# }
