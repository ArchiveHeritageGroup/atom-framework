#
# AtoM Framework - Extension Nginx Configuration
# ========================================================
# Include this file in your nginx server block to enable
# media streaming, IIIF viewer, and other extension routes.
#
# Usage in your nginx config:
#   include /path/to/atom-framework/config/nginx/extensions.conf;
#
# Place this BEFORE the main PHP handler and catch-all location blocks.
#

# ======================================
# MEDIA STREAMING & SNIPPETS (Symfony routes)
# Handled by the media module via Symfony routing
# ======================================

# Media streaming - pass through Symfony for transcoding support
# Buffering disabled for real-time streaming
location ~ ^/media/stream/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/stream/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/stream/$1;
    fastcgi_read_timeout 600;
    fastcgi_buffering off;
    add_header X-Accel-Buffering no;
}

# Media download
location ~ ^/media/download/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/download/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/download/$1;
}

# Media snippets - list by digital object ID
location ~ ^/media/snippets/([0-9]+)$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/snippets/$1;
    fastcgi_param PATH_TRANSLATED $document_root/media/snippets/$1;
}

# Media snippets - save (POST)
location = /media/snippets {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param SCRIPT_NAME /index.php;
    fastcgi_param PATH_INFO /media/snippets;
    fastcgi_param PATH_TRANSLATED $document_root/media/snippets;
}

# ======================================
# IIIF MEDIA API ROUTES
# Metadata extraction, waveforms, transcription
# ======================================

# Media metadata, extraction, waveform
location ~ ^/media/(metadata|extract|waveform)/([0-9]+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# Transcription routes (longer timeout for processing)
location ~ ^/media/(transcription|transcribe)/([0-9]+)(.*)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    fastcgi_read_timeout 600;
    add_header Access-Control-Allow-Origin * always;
}

# Media search
location ~ ^/media/search {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# ======================================
# IIIF VIEWER ROUTES
# Manifests, viewer, annotations, OCR, search
# ======================================

# IIIF Manifest generation
location ~ ^/iiif/manifest/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF Collection
location ~ ^/iiif/collection/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF Viewer
location ~ ^/iiif/viewer/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
}

# IIIF Embed
location ~ ^/iiif/embed/(.+)$ {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
}

# IIIF Annotations
location ~ ^/iiif/annotations {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
    add_header Access-Control-Allow-Origin * always;
}

# IIIF OCR
location ~ ^/iiif/ocr {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
}

# IIIF Text
location ~ ^/iiif/text {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
}

# IIIF Search
location ~ ^/iiif/search {
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/atom-framework/src/Extensions/Iiif/public/router.php;
}

# IIIF Viewer static assets
# Note: Using try_files instead of alias to avoid $document_root limitation
location /atom-framework/src/Extensions/Iiif/public/ {
    try_files $uri =404;
    expires 7d;
}

# ======================================
# IIIF IMAGE SERVER (CANTALOUPE) PROXY
# Requires Cantaloupe running on port 8182
# ======================================

# Uncomment if you have Cantaloupe installed:
# location /iiif/ {
#     proxy_pass http://127.0.0.1:8182/iiif/;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     add_header Access-Control-Allow-Origin "*" always;
# }
