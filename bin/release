#!/bin/bash
# Usage: ./bin/release patch|minor|major "commit message"
# Example: ./bin/release patch "Fix discover to include themes"

TYPE=${1:-patch}
MSG=${2:-"Bug fixes and improvements"}

cd "$(dirname "$0")/.."

VERSION_FILE="version.json"

if [ ! -f "$VERSION_FILE" ]; then
    echo "Error: version.json not found"
    exit 1
fi

CURRENT=$(grep '"version"' $VERSION_FILE | sed 's/.*: "\(.*\)".*/\1/')
echo "Current version: v${CURRENT}"

IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

case $TYPE in
    patch) PATCH=$((PATCH + 1)) ;;
    minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
    major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
    *) echo "Usage: ./bin/release patch|minor|major \"commit message\""; exit 1 ;;
esac

NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
DATE=$(date +%Y-%m-%d)

echo "New version: v${NEW_VERSION}"
echo ""

cat > $VERSION_FILE << EOFV
{
    "version": "${NEW_VERSION}",
    "date": "${DATE}",
    "name": "AtoM Framework",
    "description": "Laravel Query Builder integration for AtoM 2.10",
    "author": "The Archive and Heritage Group",
    "repository": "https://github.com/ArchiveHeritageGroup/atom-framework"
}
EOFV

git add -A
git commit -m "v${NEW_VERSION}: ${MSG}"
git push origin main

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Released atom-framework v${NEW_VERSION}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
