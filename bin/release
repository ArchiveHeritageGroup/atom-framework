#!/bin/bash
#===============================================================================
# AtoM Framework Release Script
# Creates versioned releases with GitHub Release (download tracking)
#
# Usage: ./bin/release patch|minor|major "commit message"
# Example: ./bin/release patch "Fix term_i18n FK constraint"
#===============================================================================

set -e

TYPE=${1:-patch}
MSG=${2:-"Bug fixes and improvements"}

cd "$(dirname "$0")/.."
REPO_NAME=$(basename $(pwd))

VERSION_FILE="version.json"

if [ ! -f "$VERSION_FILE" ]; then
    echo "Error: version.json not found"
    exit 1
fi

# Parse current version
CURRENT=$(grep '"version"' $VERSION_FILE | sed 's/.*: "\(.*\)".*/\1/')
echo "Current version: v${CURRENT}"

IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

# Calculate new version
case $TYPE in
    patch) PATCH=$((PATCH + 1)) ;;
    minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
    major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
    *) echo "Usage: ./bin/release patch|minor|major \"message\""; exit 1 ;;
esac

NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
DATE=$(date +%Y-%m-%d)
TAG="v${NEW_VERSION}"

echo "New version: ${TAG}"
echo ""

# Update version.json
cat > $VERSION_FILE << EOFV
{
    "version": "${NEW_VERSION}",
    "date": "${DATE}",
    "name": "AtoM Framework",
    "description": "Laravel Query Builder integration for AtoM 2.10",
    "author": "The Archive and Heritage Group",
    "repository": "https://github.com/ArchiveHeritageGroup/atom-framework"
}
EOFV

# Git operations
git add -A
git commit -m "${TAG}: ${MSG}"

# Create annotated tag
git tag -a "${TAG}" -m "${MSG}"

# Push commit and tag
git push origin main
git push origin "${TAG}"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Create GitHub Release (provides download tracking)
if command -v gh &> /dev/null; then
    echo "Creating GitHub Release..."
    
    # Generate release notes
    RELEASE_NOTES="## What's Changed

${MSG}

## Installation

\`\`\`bash
cd /usr/share/nginx/atom
git clone https://github.com/ArchiveHeritageGroup/atom-framework.git
cd atom-framework && composer install
bash bin/install
\`\`\`

## Update

\`\`\`bash
cd /usr/share/nginx/atom/atom-framework
php bin/atom framework:update
\`\`\`

---
**Full Changelog**: https://github.com/ArchiveHeritageGroup/atom-framework/compare/v${CURRENT}...${TAG}"

    # Create release with auto-generated source archives
    gh release create "${TAG}" \
        --title "${TAG} - ${MSG}" \
        --notes "${RELEASE_NOTES}" \
        --latest
    
    echo ""
    echo "✓ GitHub Release created with download tracking"
    echo "  View: https://github.com/ArchiveHeritageGroup/atom-framework/releases/tag/${TAG}"
else
    echo "⚠ GitHub CLI (gh) not installed - skipping GitHub Release"
    echo "  Install with: sudo apt install gh"
    echo "  Tag pushed: ${TAG}"
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Released atom-framework ${TAG}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
