#!/bin/bash
#===============================================================================
# AtoM AHG Framework - Release Script
# Usage: ./bin/release patch|minor|major "commit message"
#===============================================================================

set -e

TYPE=${1:-patch}
MSG=${2:-"Bug fixes and improvements"}

cd "$(dirname "$0")/.."

VERSION_FILE="version.json"

if [ ! -f "$VERSION_FILE" ]; then
    echo "Error: version.json not found"
    exit 1
fi

# Parse version using php (reliable JSON parsing)
CURRENT=$(php -r "\$j=json_decode(file_get_contents('${VERSION_FILE}'),true); echo \$j['version'] ?? '1.0.0';")

if [ -z "$CURRENT" ] || [ "$CURRENT" = "null" ]; then
    echo "Error: Could not parse version"
    exit 1
fi

echo "Current version: v${CURRENT}"

# Split version
MAJOR=$(echo "$CURRENT" | cut -d. -f1)
MINOR=$(echo "$CURRENT" | cut -d. -f2)
PATCH=$(echo "$CURRENT" | cut -d. -f3)

# Calculate new version
case $TYPE in
    patch) PATCH=$((PATCH + 1)) ;;
    minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
    major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
    *) echo "Usage: ./bin/release patch|minor|major \"message\""; exit 1 ;;
esac

NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
DATE=$(date +%Y-%m-%d)
TAG="v${NEW_VERSION}"

echo "New version: ${TAG}"
echo ""

# Update version.json using php
php -r "
\$j = json_decode(file_get_contents('${VERSION_FILE}'), true);
\$j['version'] = '${NEW_VERSION}';
\$j['release_date'] = '${DATE}';
file_put_contents('${VERSION_FILE}', json_encode(\$j, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . \"\n\");
"

# Git operations
git add -A
git commit -m "${TAG}: ${MSG}"
git tag -a "${TAG}" -m "${MSG}"
git push origin main
git push origin "${TAG}"

echo ""
echo "âœ… Released ${TAG}"
echo ""
