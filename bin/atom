#!/usr/bin/env php
<?php
/**
 * AtoM CLI - Extension Manager
 *
 * Usage: php bin/atom extension:list
 *        php bin/atom extension:install <name>
 *        php bin/atom extension:enable <name>
 */

// Define paths
define('ATOM_ROOT', dirname(__DIR__, 2));
define('FRAMEWORK_ROOT', dirname(__DIR__));

// Parse command (extension:list -> extension list)
$args = $argv;
$script = array_shift($args);

if (isset($args[0]) && strpos($args[0], ':') !== false) {
    $parts = explode(':', $args[0], 2);
    $args[0] = $parts[0];
    array_splice($args, 1, 0, $parts[1]);
}

// Bootstrap the framework
$bootstrap = FRAMEWORK_ROOT . '/bootstrap.php';
if (!file_exists($bootstrap)) {
    echo "\033[31mError: bootstrap.php not found at {$bootstrap}\033[0m\n";
    exit(1);
}

require_once $bootstrap;

// Route to appropriate command
$module = $args[0] ?? 'help';
$command = $args[1] ?? 'help';
$remaining = array_slice($args, 2);

switch ($module) {
    case 'extension':
        require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
        $cmd = new \AtomFramework\Console\ExtensionCommand(array_merge(['atom', $command], $remaining));
        exit($cmd->run());
        
    case 'help':
    case '--help':
    case '-h':
        echo <<<HELP
AtoM Framework CLI v1.0.0

Usage: php bin/atom <module>:<command> [arguments] [options]

Available modules:
  extension     Manage extensions (list, install, enable, disable, etc.)

Examples:
  php bin/atom extension:list
  php bin/atom extension:discover
  php bin/atom extension:install arSecurityClearancePlugin
  php bin/atom extension:enable arSecurityClearancePlugin

Run 'php bin/atom extension:help' for extension-specific commands.

HELP;
        exit(0);
        
    default:
        echo "\033[31mUnknown module: {$module}\033[0m\n";
        echo "Run 'php bin/atom help' for available commands.\n";
        exit(1);
}
