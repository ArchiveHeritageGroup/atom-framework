#!/usr/bin/env php
<?php
/**
 * AtoM CLI - Extension Manager
 */
define('ATOM_ROOT', dirname(__DIR__, 2));
define('FRAMEWORK_ROOT', dirname(__DIR__));
define('ATOM_CLI_MODE', true);

// Bootstrap the framework
$bootstrap = FRAMEWORK_ROOT . '/bootstrap.php';
if (!file_exists($bootstrap)) {
    echo "\033[31mError: bootstrap.php not found\033[0m\n";
    exit(1);
}
require_once $bootstrap;

// Parse command
$args = $argv;
array_shift($args);

if (isset($args[0]) && strpos($args[0], ':') !== false) {
    $parts = explode(':', $args[0], 2);
    $args[0] = $parts[0];
    array_splice($args, 1, 0, $parts[1]);
}

$module = $args[0] ?? 'help';
$command = $args[1] ?? 'help';
$remaining = array_slice($args, 2);

switch ($module) {
    case 'extension':
        require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
        $cmd = new \AtomFramework\Console\ExtensionCommand(array_merge(['atom', $command], $remaining));
        exit($cmd->run());

    case 'migrate':
        require_once FRAMEWORK_ROOT . '/src/Database/MigrationRunner.php';
        require_once FRAMEWORK_ROOT . '/src/Console/MigrateCommand.php';
        $cmd = new \AtomFramework\Console\MigrateCommand();
        exit($cmd->run(array_merge([$command], $remaining)));

    case 'thesaurus':
        $semanticPlugin = ATOM_ROOT . '/atom-ahg-plugins/ahgSemanticSearchPlugin';
        require_once $semanticPlugin . '/lib/Services/ThesaurusService.php';
        require_once $semanticPlugin . '/lib/Services/WordNetSyncService.php';
        require_once $semanticPlugin . '/lib/Services/WikidataSyncService.php';
        require_once $semanticPlugin . '/lib/Commands/ThesaurusCommand.php';
        $cmd = new \AtomFramework\Console\ThesaurusCommand(array_merge(['atom', $command], $remaining));
        exit($cmd->run());

    case 'framework':
        switch ($command) {
            case 'install':
                runFrameworkInstall();
                exit(0);
            case 'update':
                exit(runFrameworkUpdate($remaining));
            case 'version':
                showFrameworkVersion();
                exit(0);
            default:
                echo "\033[31mUnknown framework command: {$command}\033[0m\n";
                echo "Available: install, update, version\n";
                exit(1);
        }

    // Shortcut commands
    case 'discover':
        require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
        $cmd = new \AtomFramework\Console\ExtensionCommand(['atom', 'discover']);
        exit($cmd->run());

    case 'install':
        if (isset($args[1])) {
            require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
            $cmd = new \AtomFramework\Console\ExtensionCommand(array_merge(['atom', 'install'], array_slice($args, 1)));
            exit($cmd->run());
        }
        showHelp();
        exit(1);

    case 'enable':
        if (isset($args[1])) {
            require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
            $cmd = new \AtomFramework\Console\ExtensionCommand(array_merge(['atom', 'enable'], array_slice($args, 1)));
            exit($cmd->run());
        }
        showHelp();
        exit(1);

    case 'disable':
        if (isset($args[1])) {
            require_once FRAMEWORK_ROOT . '/src/Console/ExtensionCommand.php';
            $cmd = new \AtomFramework\Console\ExtensionCommand(array_merge(['atom', 'disable'], array_slice($args, 1)));
            exit($cmd->run());
        }
        showHelp();
        exit(1);

    case 'help':
    case '--help':
    case '-h':
    case 'list':
        require_once FRAMEWORK_ROOT . '/src/Console/BaseCommand.php';
        require_once FRAMEWORK_ROOT . '/src/Console/CommandRegistry.php';
        $registry = new \AtomFramework\Console\CommandRegistry(ATOM_ROOT);
        $registry->discover();
        showHelp($registry);
        exit(0);

    case 'update':
        exit(runFullUpdate($remaining));

    default:
        // Try auto-discovered commands via CommandRegistry
        $fullCommand = $module . ':' . $command;
        require_once FRAMEWORK_ROOT . '/src/Console/BaseCommand.php';
        require_once FRAMEWORK_ROOT . '/src/Console/CommandRegistry.php';
        $registry = new \AtomFramework\Console\CommandRegistry(ATOM_ROOT);
        $registry->discover();

        if ($registry->has($fullCommand)) {
            $cmd = $registry->get($fullCommand, $remaining);
            if ($cmd) {
                exit($cmd->run());
            }
        }

        echo "\033[31mUnknown command: {$module}" . ($command !== 'help' ? ":{$command}" : '') . "\033[0m\n";
        showHelp($registry);
        exit(1);
}

function runFrameworkInstall(): void
{
    echo "Installing AtoM Framework...\n";
    echo str_repeat('═', 60) . "\n";

    // Step 1: Run composer install
    echo "→ Step 1: Running composer install...\n";
    chdir(FRAMEWORK_ROOT);
    passthru("composer install --no-dev --optimize-autoloader 2>&1");

    // Step 2: Create plugin symlinks
    echo "\n→ Step 2: Creating plugin symlinks...\n";
    $ahgPlugins = ATOM_ROOT . '/atom-ahg-plugins';
    $pluginsDir = ATOM_ROOT . '/plugins';

    if (is_dir($ahgPlugins)) {
        $plugins = glob($ahgPlugins . '/ahg*', GLOB_ONLYDIR);
        foreach ($plugins as $pluginPath) {
            $pluginName = basename($pluginPath);
            $linkPath = $pluginsDir . '/' . $pluginName;

            if (!is_link($linkPath)) {
                if (symlink($pluginPath, $linkPath)) {
                    echo "  \033[32m✓\033[0m Linked {$pluginName}\n";
                } else {
                    echo "  \033[31m✗\033[0m Failed to link {$pluginName}\n";
                }
            } else {
                echo "  \033[33m→\033[0m {$pluginName} already linked\n";
            }
        }
    } else {
        echo "  \033[33m⚠\033[0m atom-ahg-plugins not found at {$ahgPlugins}\n";
    }

    // Step 3: Run migrations
    echo "\n→ Step 3: Running migrations...\n";
    require_once FRAMEWORK_ROOT . '/src/Database/MigrationRunner.php';
    require_once FRAMEWORK_ROOT . '/src/Console/MigrateCommand.php';
    $migrate = new \AtomFramework\Console\MigrateCommand();
    $migrate->run(['up']);

    echo "\n\033[32m✓ Framework installed successfully\033[0m\n";
    echo "\nNote: For full installation (database tables, themes, patches), run:\n";
    echo "  ./bin/install\n";
}

function runFrameworkUpdate(array $args): int
{
    echo "Updating AtoM Framework...\n";
    echo str_repeat('═', 60) . "\n";

    $branch = $args[0] ?? 'main';

    // Pull latest from git
    chdir(FRAMEWORK_ROOT);
    echo "→ Pulling latest from {$branch}...\n";
    $errors = [];
    forceGitPull(FRAMEWORK_ROOT, $branch, $errors, 'Framework');

    if (!empty($errors)) {
        echo "\033[31m✗ Git pull failed\033[0m\n";
        return 1;
    }


    // Run migrations
    echo "→ Running migrations...\n";
    require_once FRAMEWORK_ROOT . '/src/Database/MigrationRunner.php';
    require_once FRAMEWORK_ROOT . '/src/Console/MigrateCommand.php';
    $migrate = new \AtomFramework\Console\MigrateCommand();
    $migrate->run(['up']);

    echo "\n\033[32m✓ Framework updated successfully\033[0m\n";
    return 0;
}

function runFullUpdate(array $args): int
{
    echo "\n";
    echo "╔════════════════════════════════════════════════════════════╗\n";
    echo "║           AtoM AHG Framework - Full Update                 ║\n";
    echo "╚════════════════════════════════════════════════════════════╝\n";
    echo "\n";

    $branch = $args[0] ?? 'main';
    $errors = [];

    // 1. Update framework
    echo "┌─────────────────────────────────────────────────────────────┐\n";
    echo "│ Step 1: Updating atom-framework                             │\n";
    echo "└─────────────────────────────────────────────────────────────┘\n";

    chdir(FRAMEWORK_ROOT);
    forceGitPull(FRAMEWORK_ROOT, $branch, $errors, 'Framework');

    // 2. Update plugins
    echo "\n┌─────────────────────────────────────────────────────────────┐\n";
    echo "│ Step 2: Updating atom-ahg-plugins                           │\n";
    echo "└─────────────────────────────────────────────────────────────┘\n";

    $pluginsDir = ATOM_ROOT . '/atom-ahg-plugins';
    if (is_dir($pluginsDir)) {
        chdir($pluginsDir);
        forceGitPull($pluginsDir, $branch, $errors, 'Plugins');
    }

    // 3. Composer install
    echo "\n┌─────────────────────────────────────────────────────────────┐\n";

    // 4. Run migrations
    echo "\n┌─────────────────────────────────────────────────────────────┐\n";
    echo "│ Step 3: Running migrations                                  │\n";
    echo "└─────────────────────────────────────────────────────────────┘\n";

    require_once FRAMEWORK_ROOT . '/src/Database/MigrationRunner.php';
    require_once FRAMEWORK_ROOT . '/src/Console/MigrateCommand.php';
    $migrate = new \AtomFramework\Console\MigrateCommand();
    $migrate->run(['up']);

    // 5. Clear cache
    echo "\n┌─────────────────────────────────────────────────────────────┐\n";
    echo "│ Step 4: Clearing cache                                      │\n";
    echo "└─────────────────────────────────────────────────────────────┘\n";

    chdir(ATOM_ROOT);
    passthru("php symfony cc 2>&1");

    // Summary
    echo "\n";
    if (empty($errors)) {
        echo "\033[32m╔════════════════════════════════════════════════════════════╗\033[0m\n";
        echo "\033[32m║  ✓ Update completed successfully                           ║\033[0m\n";
        echo "\033[32m╚════════════════════════════════════════════════════════════╝\033[0m\n";
        return 0;
    } else {
        echo "\033[33m╔════════════════════════════════════════════════════════════╗\033[0m\n";
        echo "\033[33m║  ⚠ Update completed with warnings                          ║\033[0m\n";
        echo "\033[33m╚════════════════════════════════════════════════════════════╝\033[0m\n";
        foreach ($errors as $error) {
            echo "  → {$error}\n";
        }
        return 1;
    }
}

function forceGitPull(string $dir, string $branch, array &$errors, string $label): void
{
    // Fix dubious ownership for deployment targets
    exec("git config --global --add safe.directory " . escapeshellarg($dir) . " 2>&1");

    // Fetch latest
    passthru("git fetch origin {$branch} 2>&1", $fetchResult);
    if ($fetchResult !== 0) {
        $errors[] = "{$label} git fetch failed";

        return;
    }

    // Check for local changes
    $localChanges = trim(shell_exec("git status --porcelain 2>&1") ?? '');
    if ($localChanges !== '') {
        echo "  → Discarding local changes on deployment target...\n";
    }

    // Reset to match remote exactly
    passthru("git reset --hard origin/{$branch} 2>&1", $resetResult);
    if ($resetResult !== 0) {
        $errors[] = "{$label} git reset failed";
    }
}

function showFrameworkVersion(): void
{
    $versionFile = FRAMEWORK_ROOT . '/version.json';
    if (file_exists($versionFile)) {
        $version = json_decode(file_get_contents($versionFile), true);
        echo "AtoM Framework v" . ($version['version'] ?? 'unknown') . "\n";
    } else {
        echo "Version unknown\n";
    }
}

function showHelp(?\AtomFramework\Console\CommandRegistry $registry = null): void
{
    echo <<<HELP

\033[1mAtoM Heratio CLI\033[0m

\033[33mUsage:\033[0m
  php bin/atom <command> [options]

\033[33mShortcut Commands:\033[0m
  discover                    List all available extensions
  install <name>              Install an extension
  enable <name>               Enable an extension
  disable <name>              Disable an extension

\033[33mExtension Commands:\033[0m
  extension:discover          List all available extensions
  extension:install <name>    Install an extension
  extension:enable <name>     Enable an extension
  extension:disable <name>    Disable an extension
  extension:update [--all]    Update extensions
  extension:migrate <name>    Run migrations for an extension

\033[33mFramework Commands:\033[0m
  framework:install           Install the framework
  framework:update            Update the framework
  framework:version           Show framework version

\033[33mMigration Commands:\033[0m
  migrate:up                  Run pending migrations
  migrate:down                Rollback last migration
  migrate:status              Show migration status

\033[33mOther Commands:\033[0m
  update                      Full update (framework + plugins + migrations)
  list                        List all available commands
  help                        Show this help message

HELP;

    // Show auto-discovered commands
    if ($registry !== null && $registry->count() > 0) {
        $grouped = $registry->all();
        foreach ($grouped as $ns => $commands) {
            $label = ucfirst($ns);
            echo "\033[33m{$label} Commands:\033[0m\n";
            foreach ($commands as $name => $description) {
                printf("  %-30s %s\n", $name, $description);
            }
            echo "\n";
        }
    }
}
