#!/usr/bin/env php
<?php
/**
 * AtoM Framework Upgrade
 */
echo "\n";
echo "╔══════════════════════════════════════════════════════════╗\n";
echo "║          AtoM Framework Upgrade                          ║\n";
echo "╚══════════════════════════════════════════════════════════╝\n";
echo "\n";

$frameworkPath = dirname(__DIR__);
$atomRoot = dirname($frameworkPath);

// Check for uncommitted changes
chdir($frameworkPath);
exec('git status --porcelain', $changes);
if (!empty($changes)) {
    echo "⚠ Warning: You have local changes:\n";
    foreach ($changes as $change) {
        echo "  {$change}\n";
    }
    echo "\nContinue anyway? (y/N): ";
    $answer = trim(fgets(STDIN));
    if (strtolower($answer) !== 'y') {
        echo "Upgrade cancelled.\n";
        exit(0);
    }
}

// Pull latest
echo "→ Pulling latest from GitHub...\n";
exec('git pull origin main 2>&1', $output, $code);
echo implode("\n", $output) . "\n";
if ($code !== 0) {
    echo "✗ Git pull failed.\n";
    exit(1);
}

// Update composer
echo "\n→ Updating dependencies...\n";
exec('composer install --no-interaction 2>&1', $output);

// Run migrations (safe - uses IF NOT EXISTS)
echo "\n→ Checking database...\n";
require_once __DIR__ . '/../bootstrap.php';

$migrationFile = __DIR__ . '/../database/migrations/2025_01_01_000001_create_extension_tables.php';
if (file_exists($migrationFile)) {
    require_once $migrationFile;
    try {
        $migration = new CreateExtensionTables();
        $migration->up();
        echo "✓ Database up to date.\n";
    } catch (Exception $e) {
        echo "✓ Database already current.\n";
    }
}

// Run level of description migration
echo "\n→ Migrating levels of description...\n";
try {
    require_once __DIR__ . '/../src/Migrations/ExtendedLevelsOfDescription.php';
    $results = \AtomExtensions\Migrations\ExtendedLevelsOfDescription::up();
    
    if (!empty($results['created'])) {
        echo "  Created: " . implode(', ', $results['created']) . "\n";
    }
    if (!empty($results['sectors_added'])) {
        echo "  Sectors: " . count($results['sectors_added']) . " mappings added\n";
    }
    if (!empty($results['skipped'])) {
        echo "  Existing: " . count($results['skipped']) . " levels\n";
    }
    echo "✓ Levels migrated.\n";
} catch (Exception $e) {
    echo "⚠ Level migration: " . $e->getMessage() . "\n";
}

// Patch ProjectConfiguration.class.php to load framework
echo "\n→ Checking ProjectConfiguration...\n";
$projectConfig = $atomRoot . '/config/ProjectConfiguration.class.php';

if (file_exists($projectConfig)) {
    $content = file_get_contents($projectConfig);
    
    // Check if framework loading already exists
    if (strpos($content, 'atom-framework/bootstrap.php') === false) {
        echo "  Adding framework bootstrap loader...\n";
        
        // Find the position after dispatcher->connect block
        $pattern = "/(\['arWebDebugPanel',\s*'listenToLoadDebugWebPanelEvent'\]\s*\);)/";
        $replacement = "$1\n\n        // Load AtoM extensions framework\n        \$frameworkPath = sfConfig::get('sf_root_dir').'/atom-framework/bootstrap.php';\n        if (file_exists(\$frameworkPath)) {\n            require_once \$frameworkPath;\n        }";
        
        $newContent = preg_replace($pattern, $replacement, $content, 1, $count);
        
        if ($count > 0) {
            file_put_contents($projectConfig, $newContent);
            echo "✓ ProjectConfiguration patched.\n";
        } else {
            echo "⚠ Could not auto-patch. Please add manually:\n";
            echo "  require_once sfConfig::get('sf_root_dir').'/atom-framework/bootstrap.php';\n";
        }
    } else {
        echo "✓ Framework already configured.\n";
    }
} else {
    echo "⚠ ProjectConfiguration.class.php not found at {$projectConfig}\n";
}

echo "\n";
echo "════════════════════════════════════════════════════════════\n";
echo "  Upgrade complete!\n";
echo "════════════════════════════════════════════════════════════\n";
echo "\n";
