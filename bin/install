#!/bin/bash
# =============================================================================
# AtoM AHG Framework - Installation
# =============================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

PLUGINS_PATH="${ATOM_ROOT}/plugins"
AHG_PLUGINS_PATH="${ATOM_ROOT}/atom-ahg-plugins"
CONFIG_FILE="${ATOM_ROOT}/config/config.php"
PROJECT_CONFIG="${ATOM_ROOT}/config/ProjectConfiguration.class.php"

CORE_PLUGINS=(
    "arAHGThemeB5Plugin"
    "arSecurityClearancePlugin"
    "arAccessRequestPlugin"
    "arDisplayPlugin"
    "arPluginManagerPlugin"
    "arResearchPlugin"
)

echo -e "${CYAN}"
echo "=============================================="
echo "  AtoM AHG Framework - Installation"
echo "=============================================="
echo -e "${NC}"

# Check prerequisites
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}✗ AtoM config not found at ${CONFIG_FILE}${NC}"
    exit 1
fi

if [ ! -d "$AHG_PLUGINS_PATH" ]; then
    echo -e "${RED}✗ atom-ahg-plugins not found${NC}"
    echo "  Run: git clone https://github.com/ArchiveHeritageGroup/atom-ahg-plugins.git"
    exit 1
fi

if [ ! -d "$FRAMEWORK_PATH/vendor" ]; then
    echo -e "${RED}✗ Composer dependencies not installed${NC}"
    echo "  Run: composer install"
    exit 1
fi

echo -e "${GREEN}✓ Prerequisites OK${NC}"
echo ""

# Get DB credentials
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "Database: ${CYAN}${DB_NAME}${NC}"
echo ""

# Ask about database install
echo -e "${YELLOW}Database tables need to be created.${NC}"
echo ""
echo "  [A] Auto - Install tables automatically"
echo "  [M] Manual - I will run SQL files myself"
echo ""
read -p "  Select option [A/m]: " DB_CHOICE
DB_CHOICE=${DB_CHOICE:-A}

AUTO_DB=true
if [[ "$DB_CHOICE" =~ ^[Mm]$ ]]; then
    AUTO_DB=false
fi

echo ""

# Install framework tables
if $AUTO_DB; then
    echo -e "${YELLOW}→ Installing framework tables...${NC}"
    mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "${FRAMEWORK_PATH}/database/install.sql" 2>&1 | grep -v "Warning" || true
    echo -e "${GREEN}✓ Framework tables installed${NC}"
else
    echo -e "${YELLOW}Manual: Run this SQL file:${NC}"
    echo "  mysql -u $DB_USER -p $DB_NAME < ${FRAMEWORK_PATH}/database/install.sql"
fi

echo ""

# Copy plugins
echo -e "${YELLOW}→ Installing core plugins...${NC}"

for plugin in "${CORE_PLUGINS[@]}"; do
    SOURCE="${AHG_PLUGINS_PATH}/${plugin}"
    DEST="${PLUGINS_PATH}/${plugin}"
    
    if [ ! -d "$SOURCE" ]; then
        echo -e "  ${YELLOW}⚠ ${plugin} not found in repo${NC}"
        continue
    fi
    
    [ -d "$DEST" ] && rm -rf "$DEST"
    cp -r "$SOURCE" "$DEST"
    echo -e "  ${GREEN}✓ ${plugin}${NC}"
    
    # Run plugin SQL
    if $AUTO_DB; then
        for sql in "${DEST}/data/install.sql" "${DEST}/lib/install.sql"; do
            if [ -f "$sql" ]; then
                mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$sql" 2>&1 | grep -v "Warning" || true
                echo -e "    ${GREEN}✓ SQL executed${NC}"
                break
            fi
        done
    fi
done

echo ""

# Register plugins
if $AUTO_DB; then
    echo -e "${YELLOW}→ Registering plugins...${NC}"
    mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" << EOSQL
INSERT INTO atom_plugin (name, is_enabled, load_order, version) VALUES
    ('arAHGThemeB5Plugin', 1, 5, '1.0.0'),
    ('arSecurityClearancePlugin', 1, 160, '1.0.0'),
    ('arAccessRequestPlugin', 1, 170, '1.0.0'),
    ('arDisplayPlugin', 1, 180, '1.0.0'),
    ('arPluginManagerPlugin', 1, 190, '1.0.0'),
    ('arResearchPlugin', 1, 200, '1.0.0')
ON DUPLICATE KEY UPDATE is_enabled = 1, updated_at = NOW();

INSERT INTO atom_extension (machine_name, display_name, version, status, installed_at, enabled_at) VALUES
    ('arAHGThemeB5Plugin', 'AHG Theme Bootstrap 5', '1.0.0', 'enabled', NOW(), NOW()),
    ('arSecurityClearancePlugin', 'Security Clearance', '1.0.0', 'enabled', NOW(), NOW()),
    ('arAccessRequestPlugin', 'Access Request', '1.0.0', 'enabled', NOW(), NOW()),
    ('arDisplayPlugin', 'Display Plugin', '1.0.0', 'enabled', NOW(), NOW()),
    ('arPluginManagerPlugin', 'Plugin Manager', '1.0.0', 'enabled', NOW(), NOW()),
    ('arResearchPlugin', 'Researcher Portal', '1.0.0', 'enabled', NOW(), NOW())
ON DUPLICATE KEY UPDATE status = 'enabled', enabled_at = NOW();
EOSQL
    echo -e "${GREEN}✓ Plugins registered${NC}"
fi

echo ""

# =============================================================================
# Patch ProjectConfiguration.class.php
# =============================================================================
echo -e "${YELLOW}→ Patching ProjectConfiguration...${NC}"

if [ ! -f "$PROJECT_CONFIG" ]; then
    echo -e "${RED}✗ ProjectConfiguration.class.php not found${NC}"
    exit 1
fi

# Backup original
cp "$PROJECT_CONFIG" "${PROJECT_CONFIG}.bak.$(date +%Y%m%d%H%M%S)"

PATCHED=0

# -----------------------------------------------------------------------------
# Patch 1: Check if already has loadPluginsFromDatabase
# -----------------------------------------------------------------------------
if grep -q "loadPluginsFromDatabase" "$PROJECT_CONFIG"; then
    echo -e "  ${GREEN}✓ Database plugin loading already present${NC}"
else
    echo -e "  ${YELLOW}→ Adding database plugin loading...${NC}"
    
    # Step 1a: Rename $plugins = [ to $corePlugins = [
    if grep -q '^\s*\$plugins = \[' "$PROJECT_CONFIG"; then
        sed -i 's/^\(\s*\)\$plugins = \[/\1$corePlugins = [/' "$PROJECT_CONFIG"
        echo -e "    ${GREEN}✓ Renamed \$plugins to \$corePlugins${NC}"
    fi
    
    # Step 1b: Add $plugins = $this->loadPluginsFromDatabase($corePlugins); after the array
    # Find the line with 'sfPluginAdminPlugin' and add after the closing ];
    if grep -q "sfPluginAdminPlugin" "$PROJECT_CONFIG"; then
        # Use PHP to do the insertion properly
        php << 'PHPEOF'
<?php
$file = getenv('PROJECT_CONFIG') ?: '/usr/share/nginx/atom/config/ProjectConfiguration.class.php';
$content = file_get_contents($file);

// Find the plugins array and add loadPluginsFromDatabase call after it
$pattern = '/(\$corePlugins = \[[\s\S]*?\'sfPluginAdminPlugin\',?\s*\];)/';
$replacement = '$1

        // Load additional plugins from database
        $plugins = $this->loadPluginsFromDatabase($corePlugins);';

if (preg_match($pattern, $content) && !preg_match('/loadPluginsFromDatabase\(\$corePlugins\)/', $content)) {
    $content = preg_replace($pattern, $replacement, $content);
    file_put_contents($file, $content);
    echo "Added loadPluginsFromDatabase call\n";
}
PHPEOF
        echo -e "    ${GREEN}✓ Added loadPluginsFromDatabase call${NC}"
    fi
    
    # Step 1c: Add the loadPluginsFromDatabase method before class closing brace
    # Find the last } and insert method before it
    php << 'PHPEOF'
<?php
$file = getenv('PROJECT_CONFIG') ?: '/usr/share/nginx/atom/config/ProjectConfiguration.class.php';
$content = file_get_contents($file);

// Check if method already exists
if (strpos($content, 'function loadPluginsFromDatabase') !== false) {
    echo "Method already exists\n";
    exit(0);
}

$method = '
    /**
     * Load enabled plugins from database, with fallback to core plugins.
     */
    private function loadPluginsFromDatabase(array $corePlugins): array
    {
        try {
            $configPath = sfConfig::get(\'sf_root_dir\') . \'/config/config.php\';
            if (!file_exists($configPath)) {
                return $corePlugins;
            }

            $config = require $configPath;
            if (!isset($config[\'all\'][\'propel\'][\'param\'])) {
                return $corePlugins;
            }

            $params = $config[\'all\'][\'propel\'][\'param\'];
            $dsn = $params[\'dsn\'] ?? \'\';
            $dsnParts = [];

            if (!empty($dsn)) {
                $dsnWithoutDriver = preg_replace(\'/^[a-z]+:/\', \'\', $dsn);
                foreach (explode(\';\', $dsnWithoutDriver) as $part) {
                    $part = trim($part);
                    if (strpos($part, \'=\') !== false) {
                        list($key, $value) = explode(\'=\', $part, 2);
                        $dsnParts[trim($key)] = trim($value);
                    }
                }
            }

            $pdo = new PDO(
                sprintf(\'mysql:host=%s;port=%d;dbname=%s;charset=utf8mb4\',
                    $dsnParts[\'host\'] ?? \'localhost\',
                    $dsnParts[\'port\'] ?? 3306,
                    $dsnParts[\'dbname\'] ?? \'atom\'
                ),
                $params[\'username\'] ?? \'root\',
                $params[\'password\'] ?? \'\',
                [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
            );

            $stmt = $pdo->prepare(\'SELECT name FROM atom_plugin WHERE is_enabled = 1 ORDER BY load_order ASC\');
            $stmt->execute();
            $dbPlugins = $stmt->fetchAll(PDO::FETCH_COLUMN);

            if (!empty($dbPlugins)) {
                return array_values(array_unique(array_merge($corePlugins, $dbPlugins)));
            }

            return $corePlugins;

        } catch (Exception $e) {
            error_log(\'ProjectConfiguration: Failed to load plugins from database - \' . $e->getMessage());
            return $corePlugins;
        }
    }
';

// Find the last closing brace of the class and insert before it
// Look for the namespacesClassLoader method's closing brace, then the class closing brace
$lastBrace = strrpos($content, '}');
if ($lastBrace !== false) {
    // Find if there's already methods after namespacesClassLoader
    $insertPos = $lastBrace;
    $content = substr($content, 0, $insertPos) . $method . "\n" . substr($content, $insertPos);
    file_put_contents($file, $content);
    echo "Added loadPluginsFromDatabase method\n";
}
PHPEOF
    echo -e "    ${GREEN}✓ Added loadPluginsFromDatabase method${NC}"
    PATCHED=1
fi

# -----------------------------------------------------------------------------
# Patch 2: Add framework bootstrap if missing
# -----------------------------------------------------------------------------
if grep -q "atom-framework/bootstrap.php" "$PROJECT_CONFIG"; then
    echo -e "  ${GREEN}✓ Framework bootstrap already present${NC}"
else
    echo -e "  ${YELLOW}→ Adding framework bootstrap...${NC}"
    
    php << 'PHPEOF'
<?php
$file = getenv('PROJECT_CONFIG') ?: '/usr/share/nginx/atom/config/ProjectConfiguration.class.php';
$content = file_get_contents($file);

$bootstrap = '
        // Load AtoM AHG Framework
        $frameworkPath = sfConfig::get(\'sf_root_dir\').\'/atom-framework/bootstrap.php\';
        if (file_exists($frameworkPath)) {
            require_once $frameworkPath;
        }';

// Find dispatcher->connect and add after its closing );
$pattern = '/(\$this->dispatcher->connect\s*\(\s*[\'"]debug\.web\.load_panels[\'"]\s*,\s*\[[^\]]+\]\s*\);)/';
if (preg_match($pattern, $content)) {
    $content = preg_replace($pattern, '$1' . $bootstrap, $content);
    file_put_contents($file, $content);
    echo "Added framework bootstrap\n";
}
PHPEOF
    echo -e "    ${GREEN}✓ Added framework bootstrap${NC}"
    PATCHED=1
fi

if [ $PATCHED -eq 0 ]; then
    echo -e "  ${GREEN}✓ Already fully patched${NC}"
fi

echo ""

# Clear cache
echo -e "${YELLOW}→ Clearing cache...${NC}"
rm -rf "${ATOM_ROOT}/cache/"* 2>/dev/null || true
echo -e "${GREEN}✓ Cache cleared${NC}"

echo ""
echo -e "${CYAN}=============================================="
echo -e "  Installation Complete!"
echo -e "==============================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart PHP: sudo systemctl restart php8.3-fpm"
echo ""

if ! $AUTO_DB; then
    echo -e "${YELLOW}Manual SQL files to run:${NC}"
    echo "  ${FRAMEWORK_PATH}/database/install.sql"
    for plugin in "${CORE_PLUGINS[@]}"; do
        for sql in "${PLUGINS_PATH}/${plugin}/data/install.sql" "${PLUGINS_PATH}/${plugin}/lib/install.sql"; do
            [ -f "$sql" ] && echo "  $sql"
        done
    done
    echo ""
fi
