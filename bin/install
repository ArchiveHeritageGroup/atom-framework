#!/bin/bash
# =============================================================================
# AtoM Framework Installer
# Creates database tables only - does NOT modify ProjectConfiguration
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}"
echo "=============================================="
echo "  AtoM Framework Installer"
echo "=============================================="
echo -e "${NC}"

# Detect paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

echo -e "${YELLOW}Paths detected:${NC}"
echo "  Framework: $FRAMEWORK_PATH"
echo "  AtoM Root: $ATOM_ROOT"

# Get database credentials from config.php
CONFIG_FILE="${ATOM_ROOT}/config/config.php"
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: config.php not found at $CONFIG_FILE${NC}"
    exit 1
fi

DB_HOST=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/host=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'localhost';")
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "${YELLOW}Database:${NC} $DB_NAME @ $DB_HOST"

# =============================================================================
# Create database tables
# =============================================================================
echo ""
echo -e "${YELLOW}Creating database tables...${NC}"

mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" << 'EOSQL'

-- atom_plugin: Plugin registry
CREATE TABLE IF NOT EXISTS atom_plugin (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    description TEXT,
    version VARCHAR(20) DEFAULT '1.0.0',
    category VARCHAR(50) DEFAULT 'extension',
    is_enabled TINYINT(1) DEFAULT 0,
    is_core TINYINT(1) DEFAULT 0,
    load_order INT DEFAULT 100,
    dependencies JSON,
    settings JSON,
    installed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- atom_plugin_audit: Audit log
CREATE TABLE IF NOT EXISTS atom_plugin_audit (
    id INT AUTO_INCREMENT PRIMARY KEY,
    plugin_name VARCHAR(100) NOT NULL,
    action VARCHAR(50) NOT NULL,
    user_id INT,
    details JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ahg_settings: Theme/framework settings
CREATE TABLE IF NOT EXISTS ahg_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_group VARCHAR(50) DEFAULT 'general',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY (setting_key, setting_group)
);

-- Insert default settings
INSERT IGNORE INTO ahg_settings (setting_key, setting_value, setting_group) VALUES
('ahg_primary_color', '#005837', 'general'),
('ahg_secondary_color', '#37A07F', 'general'),
('ahg_card_header_bg', '#005837', 'general'),
('ahg_card_header_text', '#ffffff', 'general');

EOSQL

echo -e "${GREEN}✓ Database tables created${NC}"

# =============================================================================
# Create plugin symlinks
# =============================================================================
echo ""
echo -e "${YELLOW}Creating plugin symlinks...${NC}"

AHG_PLUGINS="${ATOM_ROOT}/atom-ahg-plugins"
PLUGINS_DIR="${ATOM_ROOT}/plugins"

if [ -d "$AHG_PLUGINS" ]; then
    for plugin in arAHGThemeB5Plugin arDisplayPlugin arAccessRequestPlugin arResearchPlugin arSecurityClearancePlugin; do
        if [ -d "${AHG_PLUGINS}/${plugin}" ]; then
            if [ ! -L "${PLUGINS_DIR}/${plugin}" ]; then
                ln -sf "${AHG_PLUGINS}/${plugin}" "${PLUGINS_DIR}/${plugin}"
                echo -e "  ${GREEN}✓${NC} Linked $plugin"
            else
                echo -e "  ${YELLOW}→${NC} $plugin already linked"
            fi
        fi
    done
else
    echo -e "${YELLOW}⚠ atom-ahg-plugins not found, skipping symlinks${NC}"
fi

# =============================================================================
# Instructions
# =============================================================================
echo ""
echo -e "${GREEN}=============================================="
echo "  Installation Complete"
echo "==============================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Add framework loading to ProjectConfiguration.class.php:"
echo ""
echo "     // Add AFTER \$this->enablePlugins(\$plugins);"
echo "     \$frameworkPath = sfConfig::get('sf_root_dir').'/atom-framework/bootstrap.php';"
echo "     if (file_exists(\$frameworkPath)) {"
echo "         require_once \$frameworkPath;"
echo "     }"
echo ""
echo "  2. Add plugins to setting_i18n (Admin → Themes to activate theme)"
echo ""
echo "  3. Clear cache:"
echo "     rm -rf ${ATOM_ROOT}/cache/*"
echo "     sudo systemctl restart php8.3-fpm"
echo ""
