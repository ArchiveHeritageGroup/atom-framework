#!/bin/bash
# =============================================================================
# AtoM Framework Installer
# Automates: table creation, symlinks, ProjectConfiguration, dist assets, themes
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}"
echo "=============================================="
echo "  AtoM Framework Installer v2.0"
echo "=============================================="
echo -e "${NC}"

# Detect paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

echo -e "${YELLOW}Paths detected:${NC}"
echo "  Framework: $FRAMEWORK_PATH"
echo "  AtoM Root: $ATOM_ROOT"

# Get database credentials from config.php
CONFIG_FILE="${ATOM_ROOT}/config/config.php"
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: config.php not found at $CONFIG_FILE${NC}"
    exit 1
fi

DB_HOST=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/host=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'localhost';")
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "${YELLOW}Database:${NC} $DB_NAME @ $DB_HOST as $DB_USER"

# =============================================================================
# Step 1: Create database tables
# =============================================================================
echo ""
echo -e "${BLUE}Step 1: Creating database tables...${NC}"

mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" << 'EOSQL'

-- =============================================
-- Core Framework Tables
-- =============================================

CREATE TABLE IF NOT EXISTS atom_plugin (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    description TEXT,
    version VARCHAR(20) DEFAULT '1.0.0',
    category VARCHAR(50) DEFAULT 'extension',
    is_enabled TINYINT(1) DEFAULT 0,
    is_core TINYINT(1) DEFAULT 0,
    load_order INT DEFAULT 100,
    dependencies JSON,
    settings JSON,
    installed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS atom_plugin_audit (
    id INT AUTO_INCREMENT PRIMARY KEY,
    plugin_name VARCHAR(100) NOT NULL,
    action VARCHAR(50) NOT NULL,
    user_id INT,
    details JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS ahg_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_group VARCHAR(50) DEFAULT 'general',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY (setting_key, setting_group)
);

INSERT IGNORE INTO ahg_settings (setting_key, setting_value, setting_group) VALUES
('ahg_primary_color', '#005837', 'general'),
('ahg_secondary_color', '#37A07F', 'general'),
('ahg_card_header_bg', '#005837', 'general'),
('ahg_card_header_text', '#ffffff', 'general');

-- =============================================
-- Display Plugin Tables
-- =============================================

CREATE TABLE IF NOT EXISTS `display_profile` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `domain` varchar(20) DEFAULT NULL,
  `layout_mode` enum('detail','hierarchy','grid','gallery','list','card','masonry','catalog') DEFAULT 'detail',
  `thumbnail_size` enum('none','small','medium','large','hero','full') DEFAULT 'medium',
  `thumbnail_position` enum('left','right','top','background','inline') DEFAULT 'left',
  `identity_fields` json DEFAULT NULL,
  `description_fields` json DEFAULT NULL,
  `context_fields` json DEFAULT NULL,
  `access_fields` json DEFAULT NULL,
  `technical_fields` json DEFAULT NULL,
  `hidden_fields` json DEFAULT NULL,
  `field_labels` json DEFAULT NULL,
  `available_actions` json DEFAULT NULL,
  `css_class` varchar(100) DEFAULT NULL,
  `is_default` tinyint(1) DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `sort_order` int DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_profile_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_object_config` (
  `id` int NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `object_type` varchar(30) DEFAULT 'archive',
  `primary_profile_id` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `object_id` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_collection_type` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(30) NOT NULL,
  `parent_id` int DEFAULT NULL,
  `icon` varchar(50) DEFAULT NULL,
  `color` varchar(20) DEFAULT NULL,
  `default_profile_id` int DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_collection_type_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_field` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `field_group` enum('identity','description','context','access','technical','admin') DEFAULT 'description',
  `data_type` enum('text','textarea','date','daterange','number','select','multiselect','relation','file','actor','term') DEFAULT 'text',
  `source_table` varchar(100) DEFAULT NULL,
  `source_column` varchar(100) DEFAULT NULL,
  `source_i18n` tinyint(1) DEFAULT '0',
  `property_type_id` int DEFAULT NULL,
  `taxonomy_id` int DEFAULT NULL,
  `relation_type_id` int DEFAULT NULL,
  `event_type_id` int DEFAULT NULL,
  `isad_element` varchar(50) DEFAULT NULL,
  `spectrum_unit` varchar(50) DEFAULT NULL,
  `dc_element` varchar(50) DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_field_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `help_text` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_level` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(30) NOT NULL,
  `parent_code` varchar(30) DEFAULT NULL,
  `domain` varchar(20) DEFAULT 'universal',
  `valid_parent_codes` json DEFAULT NULL,
  `valid_child_codes` json DEFAULT NULL,
  `icon` varchar(50) DEFAULT NULL,
  `color` varchar(20) DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `atom_term_id` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_level_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_mode_global` (
  `id` int NOT NULL AUTO_INCREMENT,
  `module` varchar(100) NOT NULL,
  `display_mode` varchar(50) NOT NULL DEFAULT 'list',
  `items_per_page` int DEFAULT '30',
  `sort_field` varchar(100) DEFAULT 'updated_at',
  `sort_direction` enum('asc','desc') DEFAULT 'desc',
  `show_thumbnails` tinyint(1) DEFAULT '1',
  `show_descriptions` tinyint(1) DEFAULT '1',
  `card_size` enum('small','medium','large') DEFAULT 'medium',
  `available_modes` json DEFAULT NULL,
  `allow_user_override` tinyint(1) DEFAULT '1',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_module` (`module`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_object_profile` (
  `id` int NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `profile_id` int NOT NULL,
  `context` varchar(30) DEFAULT 'default',
  `is_primary` tinyint(1) DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_assignment` (`object_id`,`profile_id`,`context`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `user_display_preference` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `module` varchar(100) NOT NULL,
  `display_mode` varchar(50) NOT NULL DEFAULT 'list',
  `items_per_page` int DEFAULT '30',
  `sort_field` varchar(100) DEFAULT 'updated_at',
  `sort_direction` enum('asc','desc') DEFAULT 'desc',
  `show_thumbnails` tinyint(1) DEFAULT '1',
  `show_descriptions` tinyint(1) DEFAULT '1',
  `card_size` enum('small','medium','large') DEFAULT 'medium',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_custom` tinyint(1) DEFAULT '1',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_module` (`user_id`,`module`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert default profile
INSERT IGNORE INTO display_profile (code, domain, is_default, is_active) VALUES ('archive_default', 'archive', 1, 1);
INSERT IGNORE INTO display_profile_i18n (id, culture, name, description) VALUES (1, 'en', 'Archive Default', 'Default profile for archival records');

-- =============================================
-- IIIF Viewer Settings
-- =============================================

CREATE TABLE IF NOT EXISTS iiif_viewer_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL UNIQUE,
    setting_value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

INSERT IGNORE INTO iiif_viewer_settings (setting_key, setting_value) VALUES
('homepage_collection_enabled', '0'),
('homepage_collection_id', ''),
('homepage_carousel_height', '400'),
('homepage_carousel_autoplay', '1'),
('homepage_carousel_interval', '5000'),
('homepage_show_captions', '1'),
('homepage_max_items', '10');

EOSQL

echo -e "${GREEN}✓ Database tables created${NC}"

# =============================================================================
# Step 2: Create plugin symlinks
# =============================================================================
echo ""
echo -e "${BLUE}Step 2: Creating plugin symlinks...${NC}"

AHG_PLUGINS="${ATOM_ROOT}/atom-ahg-plugins"
PLUGINS_DIR="${ATOM_ROOT}/plugins"

if [ -d "$AHG_PLUGINS" ]; then
    for plugin in arAHGThemeB5Plugin arDisplayPlugin arAccessRequestPlugin arResearchPlugin arSecurityClearancePlugin; do
        if [ -d "${AHG_PLUGINS}/${plugin}" ]; then
            if [ ! -L "${PLUGINS_DIR}/${plugin}" ]; then
                ln -sf "${AHG_PLUGINS}/${plugin}" "${PLUGINS_DIR}/${plugin}"
                echo -e "  ${GREEN}✓${NC} Linked $plugin"
            else
                echo -e "  ${YELLOW}→${NC} $plugin already linked"
            fi
        fi
    done
else
    echo -e "${YELLOW}⚠ atom-ahg-plugins not found at $AHG_PLUGINS${NC}"
fi

# =============================================================================
# Step 3: Update ProjectConfiguration
# =============================================================================
echo ""
echo -e "${BLUE}Step 3: Updating ProjectConfiguration...${NC}"

PROJECT_CONFIG="${ATOM_ROOT}/config/ProjectConfiguration.class.php"
FRAMEWORK_LOAD='$frameworkPath = sfConfig::get('\''sf_root_dir'\'').'\''/atom-framework/bootstrap.php'\'';
        if (file_exists($frameworkPath)) {
            require_once $frameworkPath;
        }'

if grep -q "atom-framework/bootstrap.php" "$PROJECT_CONFIG"; then
    echo -e "  ${YELLOW}→${NC} Framework already configured in ProjectConfiguration"
else
    # Add framework loading after enablePlugins
    sed -i "/\$this->enablePlugins(\$plugins);/a\\
        \\
        // Load AtoM extensions framework\\
        ${FRAMEWORK_LOAD}" "$PROJECT_CONFIG"
    echo -e "  ${GREEN}✓${NC} Added framework loading to ProjectConfiguration"
fi

# =============================================================================
# Step 4: Copy dist assets
# =============================================================================
echo ""
echo -e "${BLUE}Step 4: Copying dist assets...${NC}"

DIST_DIR="${ATOM_ROOT}/dist"

if [ -d "${AHG_PLUGINS}/arAHGThemeB5Plugin/dist" ]; then
    cp -f ${AHG_PLUGINS}/arAHGThemeB5Plugin/dist/css/* ${DIST_DIR}/css/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied CSS assets" || echo -e "  ${YELLOW}→${NC} No CSS to copy"
    cp -f ${AHG_PLUGINS}/arAHGThemeB5Plugin/dist/js/* ${DIST_DIR}/js/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied JS assets" || echo -e "  ${YELLOW}→${NC} No JS to copy"
else
    echo -e "  ${YELLOW}⚠${NC} AHG theme dist folder not found"
fi

# =============================================================================
# Step 5: Enable themes in setting_i18n
# =============================================================================
echo ""
echo -e "${BLUE}Step 5: Enabling themes...${NC}"

# Check if arAHGThemeB5Plugin already in plugins
CURRENT_PLUGINS=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -N -e "SELECT value FROM setting_i18n WHERE id = 1;")

if echo "$CURRENT_PLUGINS" | grep -q "arAHGThemeB5Plugin"; then
    echo -e "  ${YELLOW}→${NC} arAHGThemeB5Plugin already enabled"
else
    # Add both Dominion and AHG themes
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "UPDATE setting_i18n SET value = 'a:14:{i:0;s:10:\"sfDcPlugin\";i:1;s:18:\"arDominionB5Plugin\";i:2;s:11:\"sfEacPlugin\";i:3;s:11:\"sfEadPlugin\";i:4;s:13:\"sfIsaarPlugin\";i:5;s:12:\"sfIsadPlugin\";i:6;s:12:\"arDacsPlugin\";i:7;s:12:\"sfIsdfPlugin\";i:8;s:14:\"sfIsdiahPlugin\";i:9;s:12:\"sfModsPlugin\";i:10;s:11:\"sfRadPlugin\";i:11;s:12:\"sfSkosPlugin\";i:12;s:15:\"arDisplayPlugin\";i:13;s:18:\"arAHGThemeB5Plugin\";}' WHERE id = 1;"
    echo -e "  ${GREEN}✓${NC} Enabled arDominionB5Plugin, arDisplayPlugin, arAHGThemeB5Plugin"
fi

# =============================================================================
# Step 6: Clear cache
# =============================================================================
echo ""
echo -e "${BLUE}Step 6: Clearing cache...${NC}"

rm -rf ${ATOM_ROOT}/cache/*
echo -e "  ${GREEN}✓${NC} Cache cleared"

# =============================================================================
# Complete
# =============================================================================
echo ""
echo -e "${GREEN}=============================================="
echo "  Installation Complete!"
echo "==============================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart PHP-FPM: sudo systemctl restart php8.3-fpm"
echo "  2. Test the site"
echo ""
echo "To switch themes, go to Admin → Themes"
echo ""
