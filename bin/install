#!/bin/bash
# =============================================================================
# AtoM Framework Installer v2.4
# Automates: table creation, symlinks, ProjectConfiguration, dist assets, themes
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}"
echo "=============================================="
echo "  AtoM Framework Installer v2.4"
echo "=============================================="
echo -e "${NC}"

# Detect paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

echo -e "${YELLOW}Paths detected:${NC}"
echo "  Framework: $FRAMEWORK_PATH"
echo "  AtoM Root: $ATOM_ROOT"

# Get database credentials from config.php
CONFIG_FILE="${ATOM_ROOT}/config/config.php"
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: config.php not found at $CONFIG_FILE${NC}"
    exit 1
fi

DB_HOST=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/host=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'localhost';")
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "${YELLOW}Database:${NC} $DB_NAME @ $DB_HOST"

# MySQL command wrapper to suppress password warning
mysql_cmd() {
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" "$@" 2>/dev/null
}

mysql_cmd_file() {
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$1" 2>/dev/null
}

# Helper to run SQL file with error reporting
runSqlFile() {
    local file="$1"
    local name="$2"
    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$file" 2>&1; then
        echo -e "  ${GREEN}✓${NC} $name"
        return 0
    else
        local err=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$file" 2>&1)
        echo -e "  ${YELLOW}⚠${NC} $name (warnings)"
        echo -e "     ${YELLOW}runSqlFile ERROR: $err${NC}"
        return 0
    fi
}

# =============================================================================
# Step 1: Create database tables
# =============================================================================
echo ""
echo -e "${BLUE}Step 1: Creating database tables...${NC}"

INSTALL_SQL="${FRAMEWORK_PATH}/database/install.sql"

if [ -f "$INSTALL_SQL" ]; then
    echo -e "  ${YELLOW}→${NC} Running database/install.sql..."
    if mysql_cmd_file "$INSTALL_SQL"; then
        echo -e "  ${GREEN}✓${NC} Database tables created successfully"
    else
        echo -e "  ${RED}✗${NC} Error creating database tables"
        exit 1
    fi
else
    echo -e "  ${RED}✗${NC} install.sql not found at $INSTALL_SQL"
    exit 1
fi

echo -e "${GREEN}✓ Database tables created${NC}"

# =============================================================================
# Step 2: Create plugin symlinks
# =============================================================================
echo ""
echo -e "${BLUE}Step 2: Creating plugin symlinks...${NC}"

AHG_PLUGINS="${ATOM_ROOT}/atom-ahg-plugins"
PLUGINS_DIR="${ATOM_ROOT}/plugins"

if [ -d "$AHG_PLUGINS" ]; then
    for plugin in $(ls -d ${AHG_PLUGINS}/ahg* 2>/dev/null | xargs -n1 basename); do
        if [ -d "${AHG_PLUGINS}/${plugin}" ]; then
            if [ ! -L "${PLUGINS_DIR}/${plugin}" ]; then
                ln -sf "${AHG_PLUGINS}/${plugin}" "${PLUGINS_DIR}/${plugin}"
                echo -e "  ${GREEN}✓${NC} Linked $plugin"
            else
                echo -e "  ${YELLOW}→${NC} $plugin already linked"
            fi
        fi
    done
else
    echo -e "${YELLOW}⚠ atom-ahg-plugins not found at $AHG_PLUGINS${NC}"
fi

# =============================================================================
# Step 3: Update ProjectConfiguration
# =============================================================================
echo ""
echo -e "${BLUE}Step 3: Updating ProjectConfiguration...${NC}"

PROJECT_CONFIG="${ATOM_ROOT}/config/ProjectConfiguration.class.php"
TEMPLATE_CONFIG="${FRAMEWORK_PATH}/config/ProjectConfiguration.class.php.template"

if grep -q "loadPluginsFromDatabase" "$PROJECT_CONFIG"; then
    echo -e "  ${YELLOW}→${NC} ProjectConfiguration already has database plugin loading"
else
    cp "$PROJECT_CONFIG" "${PROJECT_CONFIG}.bak.$(date +%Y%m%d_%H%M%S)"
    echo -e "  ${GREEN}✓${NC} Backed up existing ProjectConfiguration"
    cp "$TEMPLATE_CONFIG" "$PROJECT_CONFIG"
    if [ -f "${ATOM_ROOT}/vendor/autoload.php" ]; then
        sed -i "s|vendor/composer/autoload.php|vendor/autoload.php|" "$PROJECT_CONFIG"
    fi
    echo -e "  ${GREEN}✓${NC} Installed ProjectConfiguration with database plugin loading"
fi

if grep -q "atom-framework/bootstrap.php" "$PROJECT_CONFIG"; then
    echo -e "  ${YELLOW}→${NC} Framework bootstrap already configured"
else
    echo -e "  ${RED}✗${NC} Framework bootstrap missing - run install again"
fi

# =============================================================================
# Step 4: Copy dist assets
# =============================================================================
echo ""
echo -e "${BLUE}Step 4: Copying dist assets...${NC}"

DIST_DIR="${ATOM_ROOT}/dist"

if [ -d "${AHG_PLUGINS}/ahgThemeB5Plugin/dist" ]; then
    cp -f ${AHG_PLUGINS}/ahgThemeB5Plugin/dist/css/* ${DIST_DIR}/css/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied CSS assets" || echo -e "  ${YELLOW}→${NC} No CSS to copy"
    cp -f ${AHG_PLUGINS}/ahgThemeB5Plugin/dist/js/* ${DIST_DIR}/js/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied JS assets" || echo -e "  ${YELLOW}→${NC} No JS to copy"
else
    echo -e "  ${YELLOW}⚠${NC} AHG theme dist folder not found"
fi

WATERMARK_DIR="${ATOM_ROOT}/images/watermarks"
if [ -d "${FRAMEWORK_PATH}/dist/images/watermarks" ]; then
    mkdir -p ${WATERMARK_DIR}
    cp -f ${FRAMEWORK_PATH}/dist/images/watermarks/* ${WATERMARK_DIR}/ 2>/dev/null
    chown -R www-data:www-data ${WATERMARK_DIR}
    echo -e "  ${GREEN}✓${NC} Copied watermark images"
else
    echo -e "  ${YELLOW}⚠${NC} Watermark images not found"
fi

# =============================================================================
# Step 5: Enable themes in setting_i18n
# =============================================================================
echo ""
echo -e "${BLUE}Step 5: Enabling themes and plugins...${NC}"

CURRENT_PLUGINS=$(mysql_cmd -N -e "SELECT value FROM setting_i18n WHERE id = 1;")

if echo "$CURRENT_PLUGINS" | grep -q "ahgThemeB5Plugin"; then
    echo -e "  ${YELLOW}→${NC} Plugins already configured"
else
    mysql_cmd -e "UPDATE setting_i18n SET value = 'a:15:{i:0;s:10:\"sfDcPlugin\";i:1;s:18:\"arDominionB5Plugin\";i:2;s:16:\"ahgThemeB5Plugin\";i:3;s:26:\"ahgSecurityClearancePlugin\";i:4;s:11:\"sfEacPlugin\";i:5;s:11:\"sfEadPlugin\";i:6;s:13:\"sfIsaarPlugin\";i:7;s:12:\"sfIsadPlugin\";i:8;s:12:\"arDacsPlugin\";i:9;s:12:\"sfIsdfPlugin\";i:10;s:14:\"sfIsdiahPlugin\";i:11;s:12:\"sfModsPlugin\";i:12;s:11:\"sfRadPlugin\";i:13;s:12:\"sfSkosPlugin\";i:14;s:16:\"ahgDisplayPlugin\";}' WHERE id = 1;"
    echo -e "  ${GREEN}✓${NC} Enabled core plugins"
fi

# =============================================================================
# Step 6: Clear cache
# =============================================================================
echo ""
echo -e "${BLUE}Step 6: Clearing cache...${NC}"

rm -rf ${ATOM_ROOT}/cache/*
echo -e "  ${GREEN}✓${NC} Cache cleared"

# =============================================================================
# Step 6b: Load plugin data files (DYNAMIC - all plugins with install.sql)
# =============================================================================
echo ""
echo -e "${BLUE}Step 6b: Loading plugin data...${NC}"

# Dynamically find ALL ahg plugins with install.sql
for plugin_dir in ${PLUGINS_DIR}/ahg*Plugin; do
    if [ -d "$plugin_dir" ]; then
        plugin=$(basename "$plugin_dir")
        DATA_SQL="${plugin_dir}/data/install.sql"
        if [ -f "$DATA_SQL" ]; then
            echo -e "  ${YELLOW}→${NC} Installing ${plugin}..."
            runSqlFile "$DATA_SQL" "$plugin"
        fi
    fi
done

echo -e "${GREEN}✓ Plugin data loaded${NC}"

# =============================================================================
# Step 6c: Enable required default plugins
# =============================================================================
echo ""
echo -e "${BLUE}Step 6c: Enabling required plugins...${NC}"

mysql_cmd -e "
INSERT INTO atom_plugin (name, class_name, version, is_enabled, is_core, is_locked, load_order, category, created_at, updated_at) VALUES
('ahgThemeB5Plugin', 'ahgThemeB5PluginConfiguration', '1.2.0', 0, 1, 1, 10, 'theme', NOW(), NOW()),
('ahgSecurityClearancePlugin', 'ahgSecurityClearancePluginConfiguration', '1.0.0', 1, 1, 1, 20, 'ahg', NOW(), NOW()),
('ahgDisplayPlugin', 'ahgDisplayPluginConfiguration', '1.0.0', 1, 1, 1, 30, 'ahg', NOW(), NOW())
ON DUPLICATE KEY UPDATE is_core = 1, is_locked = 1, version = VALUES(version), updated_at = NOW();
"
echo -e "  ${GREEN}✓${NC} ahgThemeB5Plugin enabled (locked)"
echo -e "  ${GREEN}✓${NC} ahgSecurityClearancePlugin enabled (locked)"
echo -e "  ${GREEN}✓${NC} ahgDisplayPlugin enabled (locked)"

# =============================================================================
# Step 6d: Sync plugin versions from extension.json
# =============================================================================
echo ""
echo -e "${BLUE}Step 6d: Syncing plugin versions...${NC}"

for plugin_dir in ${ATOM_ROOT}/atom-ahg-plugins/*Plugin; do
    if [ -d "$plugin_dir" ]; then
        plugin_name=$(basename "$plugin_dir")
        manifest="${plugin_dir}/extension.json"
        if [ -f "$manifest" ]; then
            version=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' "$manifest" | head -1 | sed 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
            if [ -n "$version" ]; then
                mysql_cmd -e "UPDATE atom_plugin SET version = '$version' WHERE name = '$plugin_name' AND (version IS NULL OR version = '');" 2>/dev/null || true
            fi
        fi
    fi
done
echo -e "  ${GREEN}✓${NC} Plugin versions synced"

# =============================================================================
# Step 7: Patch QubitMetadataRoute for GLAM sector support
# =============================================================================
echo ""
echo -e "${BLUE}Step 7: Patching QubitMetadataRoute...${NC}"

ROUTE_FILE="${ATOM_ROOT}/lib/routing/QubitMetadataRoute.class.php"
if [ -f "$ROUTE_FILE" ]; then
    if ! grep -q "ahgLibraryPlugin" "$ROUTE_FILE"; then
        sed -i "/'isdf' => 'sfIsdfPlugin',/a\        'library' => 'ahgLibraryPlugin'," "$ROUTE_FILE"
        sed -i "/'isdf' => 'sfIsdfPlugin',/a\        'gallery' => 'ahgGalleryPlugin'," "$ROUTE_FILE"
        sed -i "/'isdf' => 'sfIsdfPlugin',/a\        'dam' => 'ahgDAMPlugin'," "$ROUTE_FILE"
        sed -i "/'isdf' => 'sfIsdfPlugin',/a\        'museum' => 'ahgMuseumPlugin'," "$ROUTE_FILE"
        echo -e "  ${GREEN}✓${NC} Added GLAM plugins to METADATA_PLUGINS"
    fi
    if ! grep -q "museum.*dam.*gallery.*library" "$ROUTE_FILE"; then
        sed -i "s/\['isad', 'dc', 'mods', 'rad', 'ead', 'dacs'\]/['isad', 'dc', 'mods', 'rad', 'ead', 'dacs', 'museum', 'dam', 'gallery', 'library']/" "$ROUTE_FILE"
        echo -e "  ${GREEN}✓${NC} Added GLAM to getActionParameter"
    fi
    echo -e "  ${GREEN}✓${NC} QubitMetadataRoute patched"
else
    echo -e "  ${YELLOW}⚠${NC} QubitMetadataRoute.class.php not found"
fi

# =============================================================================
# Complete
# =============================================================================
echo ""
echo -e "${GREEN}=============================================="
echo "  Installation Complete!"
echo "==============================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart PHP-FPM: sudo systemctl restart php8.3-fpm"
echo "  2. Test the site"
echo ""
echo "To switch themes, go to Admin → Themes"
echo ""
