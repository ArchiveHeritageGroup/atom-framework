#!/bin/bash
# =============================================================================
# AtoM AHG Framework - Base Installation
# Installs and enables all core AHG plugins
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Detect ATOM_ROOT (where this script is run from or parent of atom-framework)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

PLUGINS_PATH="${ATOM_ROOT}/plugins"
AHG_PLUGINS_PATH="${ATOM_ROOT}/atom-ahg-plugins"
CONFIG_FILE="${ATOM_ROOT}/config/config.php"

# Core plugins that form the base AHG install (cannot be disabled)
CORE_PLUGINS=(
    "arAHGThemeB5Plugin"
    "arSecurityClearancePlugin"
    "arAccessRequestPlugin"
    "arDisplayPlugin"
    "arPluginManagerPlugin"
    "arResearchPlugin"
)

echo -e "${CYAN}"
echo "=============================================="
echo "  AtoM AHG Framework - Base Installation"
echo "=============================================="
echo -e "${NC}"

# Check prerequisites
echo -e "${YELLOW}→ Checking prerequisites...${NC}"

if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}✗ AtoM config not found at ${CONFIG_FILE}${NC}"
    echo "  Make sure you're installing in an AtoM directory"
    exit 1
fi

if [ ! -d "$AHG_PLUGINS_PATH" ]; then
    echo -e "${RED}✗ atom-ahg-plugins not found${NC}"
    echo "  Run: cd ${ATOM_ROOT} && git clone https://github.com/ArchiveHeritageGroup/atom-ahg-plugins.git"
    exit 1
fi

if [ ! -d "$FRAMEWORK_PATH/vendor" ]; then
    echo -e "${YELLOW}→ Installing composer dependencies...${NC}"
    cd "$FRAMEWORK_PATH"
    composer install --no-dev --quiet
fi

echo -e "${GREEN}✓ Prerequisites OK${NC}"
echo ""

# Extract DB credentials
echo -e "${YELLOW}→ Reading database configuration...${NC}"
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "${GREEN}✓ Database: ${DB_NAME}${NC}"
echo ""

# Install framework tables
echo -e "${YELLOW}→ Installing framework tables...${NC}"
if [ -f "${FRAMEWORK_PATH}/database/install.sql" ]; then
    mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "${FRAMEWORK_PATH}/database/install.sql" 2>/dev/null || true
    echo -e "${GREEN}✓ Framework tables installed${NC}"
else
    echo -e "${RED}✗ install.sql not found${NC}"
    exit 1
fi
echo ""

# Copy and install core plugins
echo -e "${YELLOW}→ Installing core AHG plugins...${NC}"
echo ""

for plugin in "${CORE_PLUGINS[@]}"; do
    SOURCE="${AHG_PLUGINS_PATH}/${plugin}"
    DEST="${PLUGINS_PATH}/${plugin}"
    
    if [ ! -d "$SOURCE" ]; then
        echo -e "  ${YELLOW}⚠ ${plugin} not found in repo, skipping${NC}"
        continue
    fi
    
    # Copy plugin files
    if [ -d "$DEST" ]; then
        echo -e "  ${CYAN}↻ Updating ${plugin}...${NC}"
        rm -rf "$DEST"
    else
        echo -e "  ${CYAN}+ Installing ${plugin}...${NC}"
    fi
    
    cp -r "$SOURCE" "$DEST"
    
    # Run plugin SQL if exists
    for sqlfile in "${DEST}/data/install.sql" "${DEST}/lib/install.sql"; do
        if [ -f "$sqlfile" ]; then
            mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$sqlfile" 2>/dev/null || true
            echo -e "    ${GREEN}✓ SQL executed${NC}"
            break
        fi
    done
    
    echo -e "  ${GREEN}✓ ${plugin} installed${NC}"
done

echo ""

# Register plugins in database
echo -e "${YELLOW}→ Registering plugins in database...${NC}"

mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" << EOF
INSERT INTO atom_plugin (name, is_enabled, load_order, version) VALUES
    ('arAHGThemeB5Plugin', 1, 5, '1.0.0'),
    ('arSecurityClearancePlugin', 1, 160, '1.0.0'),
    ('arAccessRequestPlugin', 1, 170, '1.0.0'),
    ('arDisplayPlugin', 1, 180, '1.0.0'),
    ('arPluginManagerPlugin', 1, 190, '1.0.0'),
    ('arResearchPlugin', 1, 200, '1.0.0')
ON DUPLICATE KEY UPDATE is_enabled = 1, updated_at = NOW();

INSERT INTO atom_extension (machine_name, display_name, version, status, installed_at, enabled_at) VALUES
    ('arAHGThemeB5Plugin', 'AHG Theme Bootstrap 5', '1.0.0', 'enabled', NOW(), NOW()),
    ('arSecurityClearancePlugin', 'Security Clearance', '1.0.0', 'enabled', NOW(), NOW()),
    ('arAccessRequestPlugin', 'Access Request', '1.0.0', 'enabled', NOW(), NOW()),
    ('arDisplayPlugin', 'Display Plugin', '1.0.0', 'enabled', NOW(), NOW()),
    ('arPluginManagerPlugin', 'Plugin Manager', '1.0.0', 'enabled', NOW(), NOW()),
    ('arResearchPlugin', 'Researcher Portal', '1.0.0', 'enabled', NOW(), NOW())
ON DUPLICATE KEY UPDATE status = 'enabled', enabled_at = NOW();
EOF

echo -e "${GREEN}✓ Plugins registered${NC}"
echo ""

# Clear cache
echo -e "${YELLOW}→ Clearing cache...${NC}"
rm -rf "${ATOM_ROOT}/cache/"*
echo -e "${GREEN}✓ Cache cleared${NC}"
echo ""

# Summary
echo -e "${CYAN}"
echo "=============================================="
echo "  Installation Complete!"
echo "=============================================="
echo -e "${NC}"
echo ""
echo "Installed plugins:"
for plugin in "${CORE_PLUGINS[@]}"; do
    echo -e "  ${GREEN}✓${NC} ${plugin}"
done
echo ""
echo "Next steps:"
echo "  1. Enable AHG theme in Admin > Themes"
echo "  2. Clear Symfony cache: php symfony cc"
echo "  3. Restart PHP-FPM: sudo systemctl restart php8.3-fpm"
echo ""
