#!/bin/bash
# =============================================================================
# AtoM Framework Installer v2.2
# Automates: table creation, symlinks, ProjectConfiguration, dist assets, themes
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}"
echo "=============================================="
echo "  AtoM Framework Installer v2.2"
echo "=============================================="
echo -e "${NC}"

# Detect paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_PATH="$(dirname "$SCRIPT_DIR")"
ATOM_ROOT="$(dirname "$FRAMEWORK_PATH")"

echo -e "${YELLOW}Paths detected:${NC}"
echo "  Framework: $FRAMEWORK_PATH"
echo "  AtoM Root: $ATOM_ROOT"

# Get database credentials from config.php
CONFIG_FILE="${ATOM_ROOT}/config/config.php"
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: config.php not found at $CONFIG_FILE${NC}"
    exit 1
fi

DB_HOST=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/host=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'localhost';")
DB_USER=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['username'] ?? 'atom';")
DB_PASS=$(php -r "\$c=require('${CONFIG_FILE}'); echo \$c['all']['propel']['param']['password'] ?? '';")
DB_NAME=$(php -r "\$c=require('${CONFIG_FILE}'); preg_match('/dbname=([^;]+)/', \$c['all']['propel']['param']['dsn'] ?? '', \$m); echo \$m[1] ?? 'atom';")

echo -e "${YELLOW}Database:${NC} $DB_NAME @ $DB_HOST as $DB_USER"

# =============================================================================
# Step 1: Create database tables
# =============================================================================
echo ""
echo -e "${BLUE}Step 1: Creating database tables...${NC}"

mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" << 'EOSQL'
SET FOREIGN_KEY_CHECKS=0;

-- =============================================
-- Core Framework Tables
-- =============================================

CREATE TABLE IF NOT EXISTS atom_plugin (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    description TEXT,
    version VARCHAR(20) DEFAULT '1.0.0',
    category VARCHAR(50) DEFAULT 'extension',
    is_enabled TINYINT(1) DEFAULT 0,
    is_core TINYINT(1) DEFAULT 0,
    load_order INT DEFAULT 100,
    dependencies JSON,
    settings JSON,
    installed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS atom_plugin_audit (
    id INT AUTO_INCREMENT PRIMARY KEY,
    plugin_name VARCHAR(100) NOT NULL,
    action VARCHAR(50) NOT NULL,
    user_id INT,
    details JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS ahg_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_group VARCHAR(50) DEFAULT 'general',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY (setting_key, setting_group)
);

INSERT IGNORE INTO ahg_settings (setting_key, setting_value, setting_group) VALUES
('ahg_primary_color', '#005837', 'general'),
('ahg_secondary_color', '#37A07F', 'general'),
('ahg_card_header_bg', '#005837', 'general'),
('ahg_card_header_text', '#ffffff', 'general');

-- =============================================
-- Extension Manager Tables
-- =============================================

CREATE TABLE IF NOT EXISTS atom_extension (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    machine_name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(255) NOT NULL,
    version VARCHAR(20) DEFAULT '1.0.0',
    description TEXT,
    author VARCHAR(255),
    license VARCHAR(50) DEFAULT 'GPL-3.0',
    status ENUM('installed','enabled','disabled','pending_removal') DEFAULT 'installed',
    protection_level ENUM('core','system','theme','extension') DEFAULT 'extension',
    theme_support JSON,
    requires_framework VARCHAR(20),
    requires_atom VARCHAR(20),
    requires_php VARCHAR(20),
    dependencies JSON,
    optional_dependencies JSON,
    tables_created JSON,
    shared_tables JSON,
    helpers JSON,
    install_task VARCHAR(100),
    uninstall_task VARCHAR(100),
    config_path VARCHAR(500),
    installed_at DATETIME,
    enabled_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS atom_extension_audit (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    extension_id INT UNSIGNED,
    extension_name VARCHAR(100) NOT NULL,
    action ENUM('installed','enabled','disabled','uninstalled','backup_created','data_deleted','upgraded') NOT NULL,
    performed_by INT,
    ip_address VARCHAR(45),
    details JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS atom_extension_setting (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    extension_id INT UNSIGNED NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    setting_type ENUM('string','integer','boolean','json') DEFAULT 'string',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY (extension_id, setting_key)
);

CREATE TABLE IF NOT EXISTS atom_extension_pending_deletion (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    extension_name VARCHAR(100) NOT NULL,
    table_name VARCHAR(100) NOT NULL,
    backup_path VARCHAR(500),
    delete_after DATETIME NOT NULL,
    status ENUM('pending','deleted','restored','cancelled') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- =============================================
-- Display Plugin Tables
-- =============================================

CREATE TABLE IF NOT EXISTS `display_profile` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `domain` varchar(20) DEFAULT NULL,
  `layout_mode` enum('detail','hierarchy','grid','gallery','list','card','masonry','catalog') DEFAULT 'detail',
  `thumbnail_size` enum('none','small','medium','large','hero','full') DEFAULT 'medium',
  `thumbnail_position` enum('left','right','top','background','inline') DEFAULT 'left',
  `identity_fields` json DEFAULT NULL,
  `description_fields` json DEFAULT NULL,
  `context_fields` json DEFAULT NULL,
  `access_fields` json DEFAULT NULL,
  `technical_fields` json DEFAULT NULL,
  `hidden_fields` json DEFAULT NULL,
  `field_labels` json DEFAULT NULL,
  `available_actions` json DEFAULT NULL,
  `css_class` varchar(100) DEFAULT NULL,
  `is_default` tinyint(1) DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `sort_order` int DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_profile_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_object_config` (
  `id` int NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `object_type` varchar(30) DEFAULT 'archive',
  `primary_profile_id` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `object_id` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_collection_type` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(30) NOT NULL,
  `parent_id` int DEFAULT NULL,
  `icon` varchar(50) DEFAULT NULL,
  `color` varchar(20) DEFAULT NULL,
  `default_profile_id` int DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_collection_type_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_field` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `field_group` enum('identity','description','context','access','technical','admin') DEFAULT 'description',
  `data_type` enum('text','textarea','date','daterange','number','select','multiselect','relation','file','actor','term') DEFAULT 'text',
  `source_table` varchar(100) DEFAULT NULL,
  `source_column` varchar(100) DEFAULT NULL,
  `source_i18n` tinyint(1) DEFAULT '0',
  `property_type_id` int DEFAULT NULL,
  `taxonomy_id` int DEFAULT NULL,
  `relation_type_id` int DEFAULT NULL,
  `event_type_id` int DEFAULT NULL,
  `isad_element` varchar(50) DEFAULT NULL,
  `spectrum_unit` varchar(50) DEFAULT NULL,
  `dc_element` varchar(50) DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_field_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `help_text` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_level` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(30) NOT NULL,
  `parent_code` varchar(30) DEFAULT NULL,
  `domain` varchar(20) DEFAULT 'universal',
  `valid_parent_codes` json DEFAULT NULL,
  `valid_child_codes` json DEFAULT NULL,
  `icon` varchar(50) DEFAULT NULL,
  `color` varchar(20) DEFAULT NULL,
  `sort_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `atom_term_id` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_level_i18n` (
  `id` int NOT NULL,
  `culture` varchar(10) NOT NULL DEFAULT 'en',
  `name` varchar(100) NOT NULL,
  `description` text,
  PRIMARY KEY (`id`,`culture`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_mode_global` (
  `id` int NOT NULL AUTO_INCREMENT,
  `module` varchar(100) NOT NULL,
  `display_mode` varchar(50) NOT NULL DEFAULT 'list',
  `items_per_page` int DEFAULT '30',
  `sort_field` varchar(100) DEFAULT 'updated_at',
  `sort_direction` enum('asc','desc') DEFAULT 'desc',
  `show_thumbnails` tinyint(1) DEFAULT '1',
  `show_descriptions` tinyint(1) DEFAULT '1',
  `card_size` enum('small','medium','large') DEFAULT 'medium',
  `available_modes` json DEFAULT NULL,
  `allow_user_override` tinyint(1) DEFAULT '1',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_module` (`module`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `display_object_profile` (
  `id` int NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `profile_id` int NOT NULL,
  `context` varchar(30) DEFAULT 'default',
  `is_primary` tinyint(1) DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_assignment` (`object_id`,`profile_id`,`context`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `user_display_preference` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `module` varchar(100) NOT NULL,
  `display_mode` varchar(50) NOT NULL DEFAULT 'list',
  `items_per_page` int DEFAULT '30',
  `sort_field` varchar(100) DEFAULT 'updated_at',
  `sort_direction` enum('asc','desc') DEFAULT 'desc',
  `show_thumbnails` tinyint(1) DEFAULT '1',
  `show_descriptions` tinyint(1) DEFAULT '1',
  `card_size` enum('small','medium','large') DEFAULT 'medium',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_custom` tinyint(1) DEFAULT '1',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_module` (`user_id`,`module`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT IGNORE INTO display_profile (code, domain, is_default, is_active) VALUES ('archive_default', 'archive', 1, 1);
INSERT IGNORE INTO display_profile_i18n (id, culture, name, description) VALUES (1, 'en', 'Archive Default', 'Default profile for archival records');

-- =============================================
-- IIIF Viewer Settings
-- =============================================

CREATE TABLE IF NOT EXISTS iiif_viewer_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL UNIQUE,
    setting_value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

INSERT IGNORE INTO iiif_viewer_settings (setting_key, setting_value) VALUES
('homepage_collection_enabled', '0'),
('homepage_collection_id', ''),
('homepage_carousel_height', '400'),
('homepage_carousel_autoplay', '1'),
('homepage_carousel_interval', '5000'),
('homepage_show_captions', '1'),
('homepage_max_items', '10');

-- =============================================
-- Security Clearance Plugin Tables
-- =============================================

CREATE TABLE IF NOT EXISTS `security_classification` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `code` varchar(20) NOT NULL,
  `level` tinyint unsigned NOT NULL,
  `name` varchar(100) NOT NULL,
  `description` text,
  `color` varchar(20) DEFAULT NULL,
  `icon` varchar(100) DEFAULT NULL,
  `requires_justification` tinyint(1) NOT NULL DEFAULT '0',
  `requires_approval` tinyint(1) NOT NULL DEFAULT '0',
  `requires_2fa` tinyint(1) NOT NULL DEFAULT '0',
  `max_session_hours` int DEFAULT NULL,
  `watermark_required` tinyint(1) NOT NULL DEFAULT '0',
  `watermark_image` varchar(255) DEFAULT NULL,
  `download_allowed` tinyint(1) NOT NULL DEFAULT '1',
  `print_allowed` tinyint(1) NOT NULL DEFAULT '1',
  `copy_allowed` tinyint(1) NOT NULL DEFAULT '1',
  `active` tinyint(1) NOT NULL DEFAULT '1',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_security_classification_level` (`level`),
  UNIQUE KEY `idx_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `watermark_type` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `name` varchar(100) NOT NULL,
  `image_file` varchar(255) NOT NULL,
  `position` varchar(50) DEFAULT 'repeat',
  `opacity` decimal(3,2) DEFAULT '0.30',
  `active` tinyint(1) DEFAULT '1',
  `sort_order` int DEFAULT '0',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `custom_watermark` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `object_id` int unsigned DEFAULT NULL,
  `name` varchar(100) NOT NULL,
  `filename` varchar(255) NOT NULL,
  `file_path` varchar(500) NOT NULL,
  `position` varchar(50) DEFAULT 'center',
  `opacity` decimal(3,2) DEFAULT '0.40',
  `created_by` int unsigned DEFAULT NULL,
  `active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_object` (`object_id`),
  KEY `idx_active` (`active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_compartment` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text,
  `min_clearance_id` int unsigned DEFAULT NULL,
  `requires_need_to_know` tinyint(1) DEFAULT '1',
  `requires_briefing` tinyint(1) DEFAULT '0',
  `active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_active` (`active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `object_security_classification` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `classification_id` int unsigned NOT NULL,
  `classified_by` int DEFAULT NULL,
  `classified_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `assigned_by` int unsigned DEFAULT NULL,
  `assigned_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `review_date` date DEFAULT NULL,
  `declassify_date` date DEFAULT NULL,
  `declassify_to_id` int unsigned DEFAULT NULL,
  `reason` text,
  `handling_instructions` text,
  `inherit_to_children` tinyint(1) DEFAULT '1',
  `justification` text,
  `active` tinyint(1) NOT NULL DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_osc_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_2fa_session` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `session_id` varchar(100) NOT NULL,
  `verified_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `expires_at` timestamp NOT NULL,
  `ip_address` varchar(45) DEFAULT NULL,
  `device_fingerprint` varchar(255) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_session` (`session_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_access_condition_link` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `object_id` int NOT NULL,
  `classification_id` int unsigned DEFAULT NULL,
  `access_conditions` text,
  `reproduction_conditions` text,
  `narssa_ref` varchar(100) DEFAULT NULL,
  `retention_period` varchar(50) DEFAULT NULL,
  `updated_by` int DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_access_log` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned DEFAULT NULL,
  `object_id` int NOT NULL,
  `classification_id` int unsigned NOT NULL,
  `action` varchar(50) NOT NULL,
  `access_granted` tinyint(1) NOT NULL,
  `denial_reason` varchar(255) DEFAULT NULL,
  `justification` text,
  `ip_address` varchar(45) DEFAULT NULL,
  `user_agent` varchar(255) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_sal_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_access_request` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `object_id` int unsigned DEFAULT NULL,
  `classification_id` int unsigned DEFAULT NULL,
  `compartment_id` int unsigned DEFAULT NULL,
  `request_type` enum('view','download','print','clearance_upgrade','compartment_access','renewal') NOT NULL,
  `justification` text NOT NULL,
  `duration_hours` int DEFAULT NULL,
  `priority` enum('normal','urgent','immediate') DEFAULT 'normal',
  `status` enum('pending','approved','denied','expired','cancelled') DEFAULT 'pending',
  `reviewed_by` int unsigned DEFAULT NULL,
  `reviewed_at` timestamp NULL DEFAULT NULL,
  `review_notes` text,
  `access_granted_until` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_audit_log` (
  `id` int NOT NULL AUTO_INCREMENT,
  `object_id` int DEFAULT NULL,
  `object_type` varchar(50) DEFAULT 'information_object',
  `user_id` int DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `action` varchar(100) NOT NULL,
  `action_category` varchar(50) DEFAULT 'access',
  `details` json DEFAULT NULL,
  `ip_address` varchar(45) DEFAULT NULL,
  `user_agent` text,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_object` (`object_id`),
  KEY `idx_action` (`action`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_clearance_history` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `previous_classification_id` int unsigned DEFAULT NULL,
  `new_classification_id` int unsigned DEFAULT NULL,
  `action` enum('granted','upgraded','downgraded','revoked','renewed','expired','2fa_enabled','2fa_disabled') NOT NULL,
  `changed_by` int unsigned NOT NULL,
  `reason` text,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`,`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_compliance_log` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `action` varchar(100) NOT NULL,
  `object_id` int DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `username` varchar(255) DEFAULT NULL,
  `details` text,
  `ip_address` varchar(45) DEFAULT NULL,
  `hash` varchar(64) DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_action` (`action`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_declassification_schedule` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `object_id` int unsigned NOT NULL,
  `scheduled_date` date NOT NULL,
  `from_classification_id` int unsigned NOT NULL,
  `to_classification_id` int unsigned DEFAULT NULL,
  `trigger_type` enum('date','event','retention') NOT NULL DEFAULT 'date',
  `trigger_event` varchar(255) DEFAULT NULL,
  `processed` tinyint(1) DEFAULT '0',
  `processed_at` timestamp NULL DEFAULT NULL,
  `processed_by` int unsigned DEFAULT NULL,
  `notes` text,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_scheduled` (`scheduled_date`,`processed`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_retention_schedule` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `narssa_ref` varchar(100) NOT NULL,
  `record_type` varchar(255) NOT NULL,
  `retention_period` varchar(100) NOT NULL,
  `disposal_action` varchar(100) NOT NULL,
  `legal_reference` text,
  `notes` text,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_narssa` (`narssa_ref`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `security_watermark_log` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `object_id` int unsigned NOT NULL,
  `digital_object_id` int unsigned DEFAULT NULL,
  `watermark_type` enum('visible','invisible','both') NOT NULL DEFAULT 'visible',
  `watermark_text` varchar(500) NOT NULL,
  `watermark_code` varchar(100) NOT NULL,
  `file_hash` varchar(64) DEFAULT NULL,
  `file_name` varchar(255) DEFAULT NULL,
  `ip_address` varchar(45) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`,`created_at`),
  KEY `idx_code` (`watermark_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `user_security_clearance` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `classification_id` int unsigned NOT NULL,
  `granted_by` int unsigned DEFAULT NULL,
  `granted_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `expires_at` datetime DEFAULT NULL,
  `notes` text,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_usc_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `user_security_clearance_log` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `classification_id` int unsigned DEFAULT NULL,
  `action` enum('granted','revoked','updated','expired') NOT NULL,
  `changed_by` int unsigned DEFAULT NULL,
  `notes` text,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `watermark_setting` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `setting_key` varchar(100) NOT NULL,
  `setting_value` text,
  `description` varchar(255) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `setting_key` (`setting_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `object_watermark_setting` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `object_id` int unsigned NOT NULL,
  `watermark_enabled` tinyint(1) DEFAULT '1',
  `watermark_type_id` int unsigned DEFAULT NULL,
  `custom_watermark_id` int unsigned DEFAULT NULL,
  `position` varchar(50) DEFAULT 'center',
  `opacity` decimal(3,2) DEFAULT '0.40',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `object_id` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT IGNORE INTO security_classification (code, level, name, description, color, active) VALUES
('UNCLASSIFIED', 0, 'Unclassified', 'Public information', '#28a745', 1),
('RESTRICTED', 1, 'Restricted', 'Limited distribution', '#ffc107', 1),
('CONFIDENTIAL', 2, 'Confidential', 'Sensitive information', '#fd7e14', 1),
('SECRET', 3, 'Secret', 'Highly sensitive information', '#dc3545', 1),
('TOP_SECRET', 4, 'Top Secret', 'Most sensitive information', '#6f42c1', 1);

INSERT IGNORE INTO watermark_type (code, name, image_file, position, opacity, active, sort_order) VALUES
('draft', 'Draft', 'draft.png', 'center', 0.30, 1, 1),
('confidential', 'Confidential', 'confidential.png', 'repeat', 0.20, 1, 2),
('restricted', 'Restricted', 'restricted.png', 'center', 0.30, 1, 3);

-- =============================================
-- Research Plugin Tables
-- =============================================

CREATE TABLE IF NOT EXISTS `research_researcher` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `title` varchar(50) DEFAULT NULL,
  `first_name` varchar(100) NOT NULL,
  `last_name` varchar(100) NOT NULL,
  `email` varchar(255) NOT NULL,
  `phone` varchar(50) DEFAULT NULL,
  `affiliation_type` enum('academic','government','private','independent','student','other') DEFAULT 'independent',
  `institution` varchar(255) DEFAULT NULL,
  `department` varchar(255) DEFAULT NULL,
  `position` varchar(255) DEFAULT NULL,
  `student_id` varchar(100) DEFAULT NULL,
  `research_interests` text,
  `current_project` text,
  `orcid_id` varchar(50) DEFAULT NULL,
  `id_type` enum('passport','national_id','drivers_license','student_card','other') DEFAULT NULL,
  `id_number` varchar(100) DEFAULT NULL,
  `id_verified` tinyint(1) DEFAULT '0',
  `id_verified_by` int DEFAULT NULL,
  `id_verified_at` datetime DEFAULT NULL,
  `status` enum('pending','approved','suspended','expired') DEFAULT 'pending',
  `rejection_reason` text,
  `approved_by` int DEFAULT NULL,
  `approved_at` datetime DEFAULT NULL,
  `expires_at` date DEFAULT NULL,
  `notes` text,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_reading_room` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `code` varchar(20) DEFAULT NULL,
  `description` text,
  `amenities` text,
  `capacity` int DEFAULT '10',
  `location` varchar(255) DEFAULT NULL,
  `operating_hours` text,
  `rules` text,
  `advance_booking_days` int DEFAULT '14',
  `max_booking_hours` int DEFAULT '4',
  `cancellation_hours` int DEFAULT '24',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `opening_time` time DEFAULT '09:00:00',
  `closing_time` time DEFAULT '17:00:00',
  `days_open` varchar(50) DEFAULT 'Mon,Tue,Wed,Thu,Fri',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_booking` (
  `id` int NOT NULL AUTO_INCREMENT,
  `researcher_id` int NOT NULL,
  `reading_room_id` int NOT NULL,
  `booking_date` date NOT NULL,
  `start_time` time NOT NULL,
  `end_time` time NOT NULL,
  `purpose` text,
  `status` enum('pending','confirmed','cancelled','completed','no_show') DEFAULT 'pending',
  `confirmed_by` int DEFAULT NULL,
  `confirmed_at` datetime DEFAULT NULL,
  `cancelled_at` datetime DEFAULT NULL,
  `cancellation_reason` text,
  `checked_in_at` datetime DEFAULT NULL,
  `checked_out_at` datetime DEFAULT NULL,
  `notes` text,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_researcher` (`researcher_id`),
  KEY `idx_room` (`reading_room_id`),
  KEY `idx_date` (`booking_date`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_material_request` (
  `id` int NOT NULL AUTO_INCREMENT,
  `booking_id` int NOT NULL,
  `object_id` int NOT NULL,
  `quantity` int DEFAULT '1',
  `notes` text,
  `status` enum('requested','retrieved','delivered','in_use','returned','unavailable') DEFAULT 'requested',
  `retrieved_by` int DEFAULT NULL,
  `retrieved_at` datetime DEFAULT NULL,
  `returned_at` datetime DEFAULT NULL,
  `condition_notes` text,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_booking` (`booking_id`),
  KEY `idx_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_collection` (
  `id` int NOT NULL AUTO_INCREMENT,
  `researcher_id` int NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text,
  `is_public` tinyint(1) DEFAULT '0',
  `share_token` varchar(64) DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_researcher` (`researcher_id`),
  KEY `idx_share_token` (`share_token`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_collection_item` (
  `id` int NOT NULL AUTO_INCREMENT,
  `collection_id` int NOT NULL,
  `object_id` int NOT NULL,
  `notes` text,
  `sort_order` int DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_item` (`collection_id`,`object_id`),
  KEY `idx_collection` (`collection_id`),
  KEY `idx_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_annotation` (
  `id` int NOT NULL AUTO_INCREMENT,
  `researcher_id` int NOT NULL,
  `object_id` int NOT NULL,
  `digital_object_id` int DEFAULT NULL,
  `annotation_type` enum('note','highlight','bookmark','tag','transcription') DEFAULT 'note',
  `title` varchar(255) DEFAULT NULL,
  `content` text,
  `target_selector` text,
  `tags` varchar(500) DEFAULT NULL,
  `is_private` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_researcher` (`researcher_id`),
  KEY `idx_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_saved_search` (
  `id` int NOT NULL AUTO_INCREMENT,
  `researcher_id` int NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text,
  `search_query` text NOT NULL,
  `search_filters` text,
  `search_type` varchar(50) DEFAULT 'informationobject',
  `alert_enabled` tinyint(1) DEFAULT '0',
  `alert_frequency` enum('daily','weekly','monthly') DEFAULT 'weekly',
  `last_alert_at` datetime DEFAULT NULL,
  `new_results_count` int DEFAULT '0',
  `is_public` tinyint(1) DEFAULT '0',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_researcher` (`researcher_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_citation_log` (
  `id` int NOT NULL AUTO_INCREMENT,
  `researcher_id` int DEFAULT NULL,
  `object_id` int NOT NULL,
  `citation_style` varchar(50) NOT NULL,
  `citation_text` text NOT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_researcher` (`researcher_id`),
  KEY `idx_object` (`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `research_password_reset` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `token` varchar(64) NOT NULL,
  `expires_at` datetime NOT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_token` (`token`),
  KEY `idx_user` (`user_id`),
  KEY `idx_expires` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =============================================
-- Access Request Plugin Tables
-- =============================================

CREATE TABLE IF NOT EXISTS `access_request` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `request_type` enum('clearance','object','repository','authority','researcher') DEFAULT 'clearance',
  `scope_type` enum('single','with_children','collection','repository_all') DEFAULT 'single',
  `user_id` int unsigned NOT NULL,
  `requested_classification_id` int unsigned NOT NULL,
  `current_classification_id` int unsigned DEFAULT NULL,
  `reason` text NOT NULL,
  `justification` text,
  `urgency` enum('low','normal','high','critical') DEFAULT 'normal',
  `status` enum('pending','approved','denied','cancelled','expired') DEFAULT 'pending',
  `reviewed_by` int unsigned DEFAULT NULL,
  `reviewed_at` datetime DEFAULT NULL,
  `review_notes` text,
  `expires_at` datetime DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `access_request_approver` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `min_classification_level` int unsigned DEFAULT '0',
  `max_classification_level` int unsigned DEFAULT '5',
  `email_notifications` tinyint(1) DEFAULT '1',
  `active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user` (`user_id`),
  KEY `idx_active` (`active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `access_request_justification` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `request_id` int NOT NULL,
  `template_id` int unsigned DEFAULT NULL,
  `justification_text` text NOT NULL,
  `created_by` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_request` (`request_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `access_request_log` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `request_id` int unsigned NOT NULL,
  `action` enum('created','updated','approved','denied','cancelled','expired','escalated') NOT NULL,
  `actor_id` int unsigned DEFAULT NULL,
  `details` text,
  `ip_address` varchar(45) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_request_id` (`request_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `access_request_scope` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `request_id` int unsigned NOT NULL,
  `object_type` enum('information_object','repository','actor') NOT NULL,
  `object_id` int unsigned NOT NULL,
  `include_descendants` tinyint(1) DEFAULT '0',
  `object_title` varchar(500) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_request_id` (`request_id`),
  KEY `idx_object` (`object_type`,`object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `object_access_grant` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `request_id` int unsigned DEFAULT NULL,
  `object_type` enum('information_object','repository','actor') NOT NULL,
  `object_id` int unsigned NOT NULL,
  `include_descendants` tinyint(1) DEFAULT '0',
  `access_level` enum('view','download','edit') DEFAULT 'view',
  `granted_by` int unsigned NOT NULL,
  `granted_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `expires_at` datetime DEFAULT NULL,
  `revoked_at` datetime DEFAULT NULL,
  `revoked_by` int unsigned DEFAULT NULL,
  `notes` text,
  `active` tinyint(1) DEFAULT '1',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_object` (`object_type`,`object_id`),
  KEY `idx_active` (`active`),
  KEY `idx_request` (`request_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `user_compartment_access` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `compartment_id` int unsigned NOT NULL,
  `granted_by` int unsigned NOT NULL,
  `granted_date` date NOT NULL,
  `expiry_date` date DEFAULT NULL,
  `briefing_date` date DEFAULT NULL,
  `briefing_reference` varchar(100) DEFAULT NULL,
  `notes` text,
  `active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user_compartment` (`user_id`,`compartment_id`),
  KEY `idx_compartment` (`compartment_id`),
  KEY `idx_expiry` (`expiry_date`,`active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `access_justification_template` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `paia_section` varchar(50) DEFAULT NULL,
  `template_text` text NOT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =============================================
-- Email Settings Table
-- =============================================

CREATE TABLE IF NOT EXISTS `email_setting` (
  `id` int NOT NULL AUTO_INCREMENT,
  `setting_key` varchar(100) NOT NULL,
  `setting_value` text,
  `setting_type` enum('text','email','number','boolean','textarea','password') DEFAULT 'text',
  `setting_group` varchar(50) DEFAULT 'general',
  `description` varchar(255) DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `setting_key` (`setting_key`),
  KEY `idx_group` (`setting_group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT IGNORE INTO email_setting (setting_key, setting_value, setting_type, setting_group, description) VALUES
('smtp_host', '', 'text', 'smtp', 'SMTP server hostname'),
('smtp_port', '587', 'number', 'smtp', 'SMTP server port'),
('smtp_username', '', 'text', 'smtp', 'SMTP username'),
('smtp_password', '', 'password', 'smtp', 'SMTP password'),
('smtp_encryption', 'tls', 'text', 'smtp', 'Encryption type (tls/ssl)'),
('from_email', '', 'email', 'smtp', 'Default from email address'),
('from_name', '', 'text', 'smtp', 'Default from name');

SET FOREIGN_KEY_CHECKS=1;
EOSQL

echo -e "${GREEN}✓ Database tables created${NC}"

# =============================================================================
# Step 2: Create plugin symlinks
# =============================================================================
echo ""
echo -e "${BLUE}Step 2: Creating plugin symlinks...${NC}"

AHG_PLUGINS="${ATOM_ROOT}/atom-ahg-plugins"
PLUGINS_DIR="${ATOM_ROOT}/plugins"

if [ -d "$AHG_PLUGINS" ]; then
    for plugin in arAHGThemeB5Plugin arDisplayPlugin arAccessRequestPlugin arSecurityClearancePlugin; do
        if [ -d "${AHG_PLUGINS}/${plugin}" ]; then
            if [ ! -L "${PLUGINS_DIR}/${plugin}" ]; then
                ln -sf "${AHG_PLUGINS}/${plugin}" "${PLUGINS_DIR}/${plugin}"
                echo -e "  ${GREEN}✓${NC} Linked $plugin"
            else
                echo -e "  ${YELLOW}→${NC} $plugin already linked"
            fi
        fi
    done
else
    echo -e "${YELLOW}⚠ atom-ahg-plugins not found at $AHG_PLUGINS${NC}"
fi

# =============================================================================
# Step 3: Update ProjectConfiguration
# =============================================================================
echo ""
echo -e "${BLUE}Step 3: Updating ProjectConfiguration...${NC}"

PROJECT_CONFIG="${ATOM_ROOT}/config/ProjectConfiguration.class.php"

if grep -q "atom-framework/bootstrap.php" "$PROJECT_CONFIG"; then
    echo -e "  ${YELLOW}→${NC} Framework already configured in ProjectConfiguration"
else
    # Add framework loading after enablePlugins
    sed -i '/\$this->enablePlugins(\$plugins);/a\
\
        // Load AtoM extensions framework\
        $frameworkPath = sfConfig::get('\''sf_root_dir'\'').'\''/atom-framework/bootstrap.php'\'';\
        if (file_exists($frameworkPath)) {\
            require_once $frameworkPath;\
        }' "$PROJECT_CONFIG"
    echo -e "  ${GREEN}✓${NC} Added framework loading to ProjectConfiguration"
fi

# =============================================================================
# Step 4: Copy dist assets
# =============================================================================
echo ""
echo -e "${BLUE}Step 4: Copying dist assets...${NC}"

DIST_DIR="${ATOM_ROOT}/dist"

if [ -d "${AHG_PLUGINS}/arAHGThemeB5Plugin/dist" ]; then
    cp -f ${AHG_PLUGINS}/arAHGThemeB5Plugin/dist/css/* ${DIST_DIR}/css/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied CSS assets" || echo -e "  ${YELLOW}→${NC} No CSS to copy"
    cp -f ${AHG_PLUGINS}/arAHGThemeB5Plugin/dist/js/* ${DIST_DIR}/js/ 2>/dev/null && echo -e "  ${GREEN}✓${NC} Copied JS assets" || echo -e "  ${YELLOW}→${NC} No JS to copy"
else
    echo -e "  ${YELLOW}⚠${NC} AHG theme dist folder not found"
fi

# =============================================================================
# Step 5: Enable themes in setting_i18n
# =============================================================================
echo ""
echo -e "${BLUE}Step 5: Enabling themes and plugins...${NC}"

# Check if arAHGThemeB5Plugin already in plugins
CURRENT_PLUGINS=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -N -e "SELECT value FROM setting_i18n WHERE id = 1;")

if echo "$CURRENT_PLUGINS" | grep -q "arAHGThemeB5Plugin"; then
    echo -e "  ${YELLOW}→${NC} Plugins already configured"
else
    # Add all required plugins
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "UPDATE setting_i18n SET value = 'a:16:{i:0;s:10:\"sfDcPlugin\";i:1;s:18:\"arDominionB5Plugin\";i:2;s:11:\"sfEacPlugin\";i:3;s:11:\"sfEadPlugin\";i:4;s:13:\"sfIsaarPlugin\";i:5;s:12:\"sfIsadPlugin\";i:6;s:12:\"arDacsPlugin\";i:7;s:12:\"sfIsdfPlugin\";i:8;s:14:\"sfIsdiahPlugin\";i:9;s:12:\"sfModsPlugin\";i:10;s:11:\"sfRadPlugin\";i:11;s:12:\"sfSkosPlugin\";i:12;s:15:\"arDisplayPlugin\";i:13;s:25:\"arSecurityClearancePlugin\";i:14;s:21:\"arAccessRequestPlugin\";i:15;s:18:\"arAHGThemeB5Plugin\";}' WHERE id = 1;"
    echo -e "  ${GREEN}✓${NC} Enabled all AHG plugins"
fi

# =============================================================================
# Step 6: Clear cache
# =============================================================================
echo ""
echo -e "${BLUE}Step 6: Clearing cache...${NC}"

rm -rf ${ATOM_ROOT}/cache/*
echo -e "  ${GREEN}✓${NC} Cache cleared"

# =============================================================================
# Complete
# =============================================================================
echo ""
echo -e "${GREEN}=============================================="
echo "  Installation Complete!"
echo "==============================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Restart PHP-FPM: sudo systemctl restart php8.3-fpm"
echo "  2. Test the site"
echo ""
echo "To switch themes, go to Admin → Themes"
echo ""
