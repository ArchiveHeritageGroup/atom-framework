<?php

/**
 * Unified Framework v2 Bootstrap.
 *
 * @author Johan Pieterse <johan@theahg.co.za>
 */

use AtomFramework\Core\Database\DatabaseManager;
use AtomFramework\Museum\Services\CcoValidator;
use AtomFramework\Museum\Services\MaterialTaxonomyService;
use AtomFramework\Museum\Services\MeasurementService;
use AtomFramework\Museum\Services\ObjectCataloger;
use AtomFramework\Museum\Services\ObjectTypeManager;
use AtomFramework\Museum\Database\Migrations\MigrationRunner;
use Monolog\Logger;
use Monolog\Handler\StreamHandler;
use Psr\Log\LoggerInterface;

// Prevent direct access
if (PHP_SAPI === 'cli' 
    && isset($_SERVER['SCRIPT_FILENAME']) 
    && basename((string) $_SERVER['SCRIPT_FILENAME']) === 'bootstrap.php'
) {
    echo "ERROR: This file must be included from within AtoM.\n";
    return;
}

// 1. Load Composer autoloader
if (!file_exists(__DIR__ . '/vendor/autoload.php')) {
    throw new RuntimeException('Framework v2 vendor/autoload.php not found. Run: composer install');
}

require_once __DIR__ . '/vendor/autoload.php';

// 2. Initialize Laravel Database Capsule
if (!class_exists('\Illuminate\Database\Capsule\Manager')) {
    throw new RuntimeException('Laravel Database component not loaded');
}

// Declare $capsule in global scope
$capsule = null;

// Only initialize if not already done
if (!defined('ATOM_FRAMEWORK_V2_DB_INITIALIZED')) {
    try {
        // Load database credentials from config/config.php
		$configPhp = dirname(__DIR__).'/config/config.php';
        
        if (!file_exists($configPhp)) {
            throw new RuntimeException('config/config.php not found');
        }
        
        // Load the config array
        $config = include($configPhp);
        
        // Extract from nested structure: ['all']['propel']['param']
        if (!isset($config['all']['propel']['param'])) {
            throw new RuntimeException('Database configuration not found in config.php');
        }
        
        $dbConfig = $config['all']['propel']['param'];
        
        // Parse DSN to extract database name and host
        $dsn = $dbConfig['dsn'] ?? '';
        
        // Extract database name
        if (preg_match('/mysql:dbname=([^;]+)/', $dsn, $matches)) {
            $database = $matches[1];
        } else {
            throw new RuntimeException('Could not parse database name from DSN');
        }
        
        // Extract host (if present in DSN)
        if (preg_match('/host=([^;]+)/', $dsn, $matches)) {
            $hostname = $matches[1];
        } else {
            $hostname = 'localhost';
        }
        
        // Extract port (if present in DSN)
        if (preg_match('/port=([^;]+)/', $dsn, $matches)) {
            $port = $matches[1];
        } else {
            $port = '3306';
        }
        
        $username = $dbConfig['username'] ?? '';
        $password = $dbConfig['password'] ?? '';
        
        // Validate required fields
        if (empty($database)) {
            throw new RuntimeException('Database name not found');
        }
        
        if (empty($username)) {
            throw new RuntimeException('Database username not found');
        }
        
        // Create new Capsule instance
		$capsule = new \Illuminate\Database\Capsule\Manager();
		$GLOBALS['atom_framework_capsule'] = $capsule;
        
        $capsule->addConnection([
            'driver' => 'mysql',
            'host' => $hostname,
            'port' => $port,
            'database' => $database,
            'username' => $username,
            'password' => $password,
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => '',
            'strict' => false,
            'engine' => null,
        ]);
        
        // Make this Capsule instance available globally
        $capsule->setAsGlobal();
        
        // Setup the Eloquent ORM
        $capsule->bootEloquent();
        
        // Mark as initialized
        define('ATOM_FRAMEWORK_V2_DB_INITIALIZED', true);
        
    } catch (Exception $e) {
		error_log('[Framework v2] Database initialization failed: ' . $e->getMessage());
		throw $e;  // TEMPORARY: See the real error
	}
}

// 3. Register extension namespaces with Composer autoloader
$loader = require __DIR__ . '/vendor/autoload.php';

$loader->addPsr4('AtomExtensions\\Database\\', __DIR__ . '/src/Database/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Extensions\\', __DIR__ . '/src/Extensions/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Reports\\', __DIR__ . '/src/Reports/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Repositories\\', __DIR__ . '/src/Repositories/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Forms\\', __DIR__ . '/src/Forms/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomExtensions\\Core\\', __DIR__ . '/src/Core/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtomFramework\\Museum\\', __DIR__ . '/src/Museum/');
$loader->addPsr4('AtomFramework\\Core\\', __DIR__ . '/src/Core/');
$loader->addPsr4('AtomFramework\\Extensions\\IiifViewer\\', __DIR__ . '/src/Extensions/IiifViewer/');

// Create Simple Dependency Injection Container
if (!class_exists('SimpleContainer')) {
    class SimpleContainer implements \Psr\Container\ContainerInterface
    {
        private array $services = [];
        private array $factories = [];
        
        public function set(string $id, callable $factory): void
        {
            $this->factories[$id] = $factory;
        }
        
        public function get(string $id)
        {
            if (isset($this->services[$id])) {
                return $this->services[$id];
            }
            
            if (!isset($this->factories[$id])) {
                throw new \RuntimeException("Service '{$id}' not found in container");
            }
            
            $this->services[$id] = $this->factories[$id]();
            
            return $this->services[$id];
        }
        
        public function has(string $id): bool
        {
            return isset($this->factories[$id]) || isset($this->services[$id]);
        }
    }
}
$container = new SimpleContainer();

// Register Core Services

// Database Manager
$container->set(DatabaseManager::class, function () {
    $capsule = $GLOBALS['atom_framework_capsule'] ?? null;
    if (!$capsule instanceof \Illuminate\Database\Capsule\Manager) {
        throw new \RuntimeException('Database Capsule not initialized');
    }
    return new DatabaseManager($capsule);
});

// Logger
$container->set(LoggerInterface::class, function () {
    $logger = new Logger('atom_framework');
    
    // Main log
    $logPath = '/var/log/atom/framework.log';
    if (is_writable(dirname($logPath))) {
        $logger->pushHandler(new StreamHandler($logPath, Logger::INFO));
    }
    
    return $logger;
});

// 6. Register Museum Services

// Load museum configuration
$museumConfig = require __DIR__ . '/config/museum.php';

$container->set(CcoValidator::class, function () use ($container, $museumConfig) {
    return new CcoValidator(
        $museumConfig,
        $container->get(LoggerInterface::class)
    );
});

$container->set(ObjectTypeManager::class, function () use ($container, $museumConfig) {
    return new ObjectTypeManager(
        $museumConfig,
        $container->get(LoggerInterface::class)
    );
});

$container->set(MaterialTaxonomyService::class, function () use ($container) {
    return new MaterialTaxonomyService(
        $container->get(LoggerInterface::class)
    );
});

$container->set(MeasurementService::class, function () use ($container, $museumConfig) {
    return new MeasurementService(
        $museumConfig,
        $container->get(LoggerInterface::class)
    );
});

$container->set(ObjectCataloger::class, function () use ($container) {
    return new ObjectCataloger(
        $container->get(DatabaseManager::class),
        $container->get(LoggerInterface::class)
    );
});

$container->set(MigrationRunner::class, function () use ($container) {
    return new MigrationRunner(
        $container->get(DatabaseManager::class),
        $container->get(LoggerInterface::class)
    );
});

// 7. Mark as loaded
if (!defined('ATOM_FRAMEWORK_V2_LOADED')) {
    define('ATOM_FRAMEWORK_V2_LOADED', true);
}

// 8. Return container for use by plugins
return $container;
// Register AHG Settings Service
$loader->addPsr4('AtomExtensions\\Services\\', __DIR__ . '/src/Services/');
$loader->addPsr4('AtoM\\', __DIR__ . '/src/');
$loader->addPsr4('AtoM\\Services\\', __DIR__ . '/src/Services/');
